---
title: "DATACON - Navazující analýza dle specifikovaných kritérií"
author: "Samuel Maštálko, Vratislav Žabka"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 3
    number_sections: true
    theme: cerulean
    highlight: tango
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,          
  message = FALSE,     
  warning = FALSE,     
  results = 'hide',
  out.width = "100%"
)
```

```{r, echo = FALSE}
rm(list=ls(all=TRUE))
gc()
library(dplyr)
library(lubridate)
library(ggplot2)
library(data.table)
library(duckdb)
library(tidyr)
library(SCCS)
library(stringr)
library(scales)
library(forecast)
library(changepoint)
library(purrr)
library(kableExtra)

con <- dbConnect(duckdb::duckdb(), dbdir = "data/datacon25.duckdb")
#dbDisconnect(con, shutdown = TRUE)
```

Pro analýzu byli vybráni klienti pojištění alespoň v období `2019-01-01` až `2022-12-31` a ve věku `16-29` v roce 2021. Jako datum vakcinace je vybrané datum první dávky a jako očkovaní jsou označeni klienti s alespoň jedním záznamem o očkování. Předpis je označený jako prvopředpis, pokud u daného klienta není sledovaný žádný předpis v minulosti (i před rokem 2019).

Sledované jsou veškeré předpisy v ATC skupině `H02`.

K vrcholu vakcinace došlo `2021-06-16`, jako rozhodné datum je tedy stanoveno `2021-06-23` a podmnožina očkovaných je omezena jen na očkované v rozmezí +- 14 dní od rozhodného data.

* Počet očkovaných jedinců: 60 263
* Počet neočkovaných jedinců: 99 451
* Počet jedinců bez předpisu: 131 130

```{r, results='hide', message=FALSE, warning=FALSE}
prescriptions <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.force AS strength,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN cpzp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                          WHERE
                            i.ins_start_date < '2019-01-01' AND i.ins_end_date > '2022-12-31'
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.strength,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN ozp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN ozp_drugs_catalog d ON p.presc_id = d.presc_id 
                          WHERE
                            i.ins_start_date < '2019-01-01' AND (i.ins_end_date IS NULL OR i.ins_end_date > '2022-12-31')
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                          ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         vacc_yearmonth = floor_date(vacc_date, unit = "month"),
         presc_yearmonth = floor_date(presc_date, unit = "month"),
         vaccinated = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         sex = ifelse(sex == "Z", "F", sex),
         first_presc_flag = ifelse(!is.na(presc_date) & first_presc_date == presc_date,1,0)) %>%
    filter(
    vaccinated == "Bez vakcinace" |
    (vaccinated == "Vakcinace" &
       between(vacc_date, ymd("2021-06-23") - days(14),
                           ymd("2021-06-23") + days(14)))
  )
```
# DiD Analýza prvopředpisovosti

Sledované období je +- 365 dní od datumu vakcinace a pro nečkované je jako datum vakcinace zvoleno `2021-06-23`. Použitá metrika je počet prvopředpisů ve zvoleném období (před vakcinací, po vakcinaci) na 1 000 dosud nepředepisovaných osob.

Pro p-hodnotu míry změny uvnitř skupin (očkovaní a neočkovaní) je použita metoda [prop.test()]([https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/prop.test). Tento přístup není naprosto ideální, protože se nejedná o nezávislé množiny, ale pro orientační sledování je dostačující.

P-hodnota DiD analýzy je měřena v rámci glm modelu `glm(event ~ period * vacc_status, data = indiv_long, family = binomial())` pro interakci kategorických proměnných `period:vacc_status.Vakcinace`.

```{r}
fake_vacc_date <- as.Date("2021-06-23")

dat <- prescriptions %>%
  mutate(first_presc_date = as.Date(first_presc_date),
         vacc_date = as.Date(vacc_date)) %>%
  filter(is.na(vacc_date) |
           abs(as.numeric(vacc_date - fake_vacc_date)) <= 14) %>%
  mutate(vacc_status = case_when(!is.na(vacc_date) ~ "Vakcinace", TRUE ~ "Bez vakcinace"))


indiv <- dat %>%
  mutate(
    vacc_date_eff = if_else(vacc_status == "Vakcinace", vacc_date, fake_vacc_date),
    obs_start = vacc_date_eff - days(365),
    obs_end   = vacc_date_eff + days(365),
    
    event_pre  = !is.na(first_presc_date) &
      (first_presc_date >= obs_start & first_presc_date < vacc_date_eff),
    event_post = !is.na(first_presc_date) &
      (first_presc_date >= vacc_date_eff & first_presc_date <= obs_end),
    
    at_risk_pre  = is.na(first_presc_date) |
      (first_presc_date >= obs_start),
    at_risk_post = is.na(first_presc_date) |
      (first_presc_date >= vacc_date_eff)
  ) %>%
  distinct(client_id, .keep_all = TRUE) %>%
  mutate(
    pre_flag  = as.integer(event_pre),
    post_flag = as.integer(event_post),
    change    = post_flag - pre_flag
  )


rates_df <- indiv %>%
  group_by(vacc_status) %>%
  summarise(
    n_clients        = n(),
    n_atrisk_pre     = sum(at_risk_pre, na.rm = TRUE),
    n_event_pre      = sum(event_pre, na.rm = TRUE),
    rate_pre_per1000  = if_else(n_atrisk_pre > 0, n_event_pre / n_atrisk_pre * 1000, NA_real_),
    n_atrisk_post    = sum(at_risk_post, na.rm = TRUE),
    n_event_post     = sum(event_post, na.rm = TRUE),
    rate_post_per1000 = if_else(n_atrisk_post > 0, n_event_post / n_atrisk_post * 1000, NA_real_),
    .groups = "drop"
  )


within_tests <- rates_df %>%
  rowwise() %>%
  mutate(p_prop = if (n_atrisk_pre > 0 & n_atrisk_post > 0) {
    prop.test(c(n_event_pre, n_event_post),
              c(n_atrisk_pre, n_atrisk_post))$p.value
  } else
    NA_real_) %>%
  ungroup()


indiv_long <- indiv %>%
  select(client_id, vacc_status, pre_flag, post_flag) %>%
  pivot_longer(
    cols = c(pre_flag, post_flag),
    names_to = "period",
    values_to = "event"
  ) %>%
  mutate(period = if_else(period == "pre_flag", 0, 1),
         event = as.integer(event))

did_model <- glm(event ~ period * vacc_status,
                 data = indiv_long,
                 family = binomial())
did_p_value <- coef(summary(did_model))[["period:vacc_statusVakcinace", "Pr(>|z|)"]]

table1 <- rates_df %>%
  mutate(relative_change = rate_post_per1000 / rate_pre_per1000) %>%
  left_join(within_tests %>% select(vacc_status, p_prop), by = "vacc_status") %>%
  transmute(
    vacc_status,
    n_event_pre,
    n_event_post,
    rate_pre = rate_pre_per1000,
    rate_post = rate_post_per1000,
    relative_change,
    p_value = p_prop
  )

rel_changes <- table1 %>%
  select(vacc_status, relative_change)

did_table <- tibble(
  relative_difference = (
    rel_changes %>% filter(vacc_status == "Vakcinace") %>% pull(relative_change)
  ) /
    (
      rel_changes %>% filter(vacc_status == "Bez vakcinace") %>% pull(relative_change)
    ),
  did_p_value = did_p_value
)
```

```{r}
plot_df <- table1 %>%
  select(vacc_status, rate_pre, rate_post, relative_change) %>%
  pivot_longer(
    cols = c(rate_pre, rate_post),
    names_to = "period",
    values_to = "rate"
  ) %>%
  mutate(period = factor(
    period,
    levels = c("rate_pre", "rate_post"),
    labels = c("Před vakcinací", "Po vakcinaci")
  ))

ggplot(plot_df, aes(x = vacc_status, y = rate, fill = period)) +
  geom_col(position = position_dodge(width = 0.6), width = 0.5) +
  geom_text(
    aes(label = round(rate, 1)),
    position = position_dodge(width = 0.6),
    vjust = -0.5,
    size = 4
  ) +
  geom_label(
    data = table1,
    aes(
      x = vacc_status,
      y = 3,
      label = paste0("×", round(relative_change, 2))
    ),
    inherit.aes = FALSE,
    size = 4,
    fill = "white",
    label.size = 0
  ) +
  
  labs(title = "Míry prvopředpisovosti relativně k vakcinaci",
       x = "Vakcinační status",
       y = "Počet prvopředpisů na 1 000 dosud nepředepisovaných klientů",
       fill = "Období") +
  theme_minimal()
```

Podle grafu je patrná vyšší prvopředpisovost v obou skupinách s nižším nárustem u neočkované populace.

```{r, results = 'asis'}
table1 %>%
  transmute(
    `Vakcinační status` = vacc_status,
    `Míra před` = rate_pre,
    `Míra po` = rate_post,
    `Relativní změna` = relative_change,
    `p-hodnota` = p_value
  ) %>%
  kable(format = "html", caption = "Porovnání míry prvopředpisovosti očkovaných a neočkovaných") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

Relativní změna je v obou skupinách statisticky významná.

```{r, results = 'asis'}
cat("```\n", paste(capture.output(print(summary(
  did_model
))), collapse = "\n"), "\n```")
```

DiD analýza ovšem nevykazuje statisticky významný rozdíl mezi skupinami (p-hodnota interkace 0.17), jediný významný prediktor prvopředpisovosti je proměnná `period` (čili období před nebo po).

# SCCS Prvopředpisy

Zde je použita metoda [SCCS](https://cran.r-project.org/web/packages/SCCS/SCCS.pdf), konkrétně tedy `standardsccs()`. Samotný model je vydefinován `coxph(formula = Surv(rep(), event) ~ exposure_start_day + strata(indivL) + offset(log(interval)), data = chopdat, method = "exact")` (tedy Coxova regrese proporcionálních rizik). Zvolené období expozice jsou 0-29, 30-89, 90-179, 180-269 a 270-365 dní od vakcinace. Každé období je potom porovnáno s ostatními (včetně baseline 365 dní před vakcinací) a míra proporcionálního rizika (HR) je poté vyjádřena jako `exp(coef)` nebo jako log(HR) `coef`. Pro testování rozdílů mezi skupinami byl použit Waldův test na rozdíl `log(HR)` v rámci DiD analýzy.

## Poměrné riziko prvopředpisů očkovaných

```{r, results = 'asis'}
vaccinated_prescribed <- prescriptions %>%
  filter(
    vaccinated == "Vakcinace",
    first_presc_date >= vacc_date - days(365),
    first_presc_date <= vacc_date + days(365),
    first_presc_flag == 1
  ) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vacc_date,
    event_date = presc_date,
    observation_start_date = vacc_date - days(365),
    observation_end_date = vacc_date + days(365)
  )

sccs_vaccinated <- vaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated
)

cat("```\n", paste(capture.output(print(
  sccs_result_vaccinated
)), collapse = "\n"), "\n```")
```

Všeobecně je riziko větší ve všech sledovaných periodách. Statistická významnost je nejvyráznější v poslední expozici (270+ dní).

## Poměrné riziko prvopředpisů neočkovaných

```{r, results = 'asis'}
unvaccinated_prescribed <- prescriptions %>%
  filter(
    vaccinated == "Bez vakcinace",
    first_presc_date >= as.Date("2021-06-23") - days(365),
    first_presc_date <= as.Date("2021-06-23") + days(365),
    first_presc_flag == 1
  ) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = as.Date("2021-06-23"),
    event_date = presc_date,
    observation_start_date = as.Date("2021-06-23") - days(365),
    observation_end_date = as.Date("2021-06-23") + days(365)
  )

sccs_unvaccinated <- unvaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated
)

cat("```\n", paste(capture.output(print(
  sccs_result_unvaccinated
)), collapse = "\n"), "\n```")
```

U neočkované populace je riziko také ve všech případech vyšší. Signifikantní výsledky jsou v prvním (0-29 dní) a posledním (270+ dní) období.

## Porovnání poměrných rizik

```{r}
coef_unvax <- sccs_result_unvaccinated$coefficients
conf_unvax <- sccs_result_unvaccinated$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated$coefficients
conf_vax <- sccs_result_vaccinated$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Bez Vakcinace")
df_vax <- df_vax %>% mutate(group = "Vakcinace")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(is.infinite(end_days),
                        paste0(start_days, "+"),
                        paste0(start_days, "-", end_days))

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high),
    width = 0.2,
    position = position_dodge(width = 0.6)
  ) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(x = "Období expozice (dny)", y = "Poměr rizik (HR)", title = "Porovnání SCCS: očkovaní vs neočkovaní") +
  theme_minimal()
```

Patrná je "výměna" pořadí míry rizika zhruba v obodbí 90-179 dní od vakcinace. Všeobecně je ale také zřejmý srovnatelný trend růstu a poklesu.

```{r}
vax_df <- combined %>%
  filter(group == "Vakcinace") %>%
  rename_with( ~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Bez Vakcinace") %>%
  rename_with( ~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                width = 0.2,
                color = "blue") +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "red") +
  labs(title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)", x = "Období expozice", y = "Rozdíl v log(HR)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Logaritmus proporcionálních rizik je možné také porovnat mezi sebou a určit "více rizikovou skupinu" pro každé období. Zde je stejně patrná výměna pozic z hlediska relativního rizika v neprospěch očkovaných v období 90-179 dní od vakcinace.

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(
    did_results,
    data.frame(
      term = term,
      period_label = period_label,
      logHR_vax = logHR_vax,
      logHR_unvax = logHR_unvax,
      DiD_logHR = DiD_logHR,
      DiD_SE = DiD_SE,
      Z = Z,
      P_value = P_value
    )
  )
}

did_results %>%
  transmute(
    Období = period_label,
    `log(HR) Vakcinace` = logHR_vax,
    `log(HR) Bez vakcinace` = logHR_unvax,
    `DiD log(HR)` = DiD_logHR,
    p_value = P_value
  ) %>%
  kable(format = "html", caption = "Porovnání rizik očkovaných a neočkovaných (SCCS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

Jediný statisticky významný výsledek je následně v období 180-269 dní od vakcinace (což je patrné i na grafu výše) s pozitivním efektem pro neočkované (nižší poměrné riziko).

# SCCS Předpisy celkem

Metodika je téměř identická jako u předchozí analýzy. V tomto případě jsou ale zahrnuty veškeré předpisy a z důvodu stejné váhy jsou předpisy injekcí a infuzí v rámci 10-denního okna agregovány do jednoho předpisu.

## Poměrné riziko předpisů očkovaných

```{r, results = 'asis'}
vaccinated_prescribed_multi <- prescriptions %>%
  filter(
    vaccinated == "Vakcinace",
    presc_date >= vacc_date - days(365),
    presc_date <= vacc_date + days(365)
  ) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vacc_date,
    event_date = presc_date,
    observation_start_date = vacc_date - days(365),
    observation_end_date = vacc_date + days(365),
    drug_form = tolower(drug_form),
    inj_or_inf = str_detect(drug_form, "injekční|infuzní")
  ) %>%
  arrange(person_id, event_date) %>%
  group_by(person_id) %>%
  mutate(keep = {
    keep_vec <- logical(n())
    next_window_start <- as.Date(NA)
    
    for (i in seq_along(event_date)) {
      if (inj_or_inf[i]) {
        if (is.na(next_window_start) || event_date[i] > next_window_start) {
          keep_vec[i] <- TRUE
          next_window_start <- event_date[i] + 10
        } else {
          keep_vec[i] <- FALSE
        }
      } else {
        keep_vec[i] <- TRUE
      }
    }
    keep_vec
  }) %>%
  filter(keep) %>%
  ungroup() %>%
  select(-keep, -drug_form, -inj_or_inf)

sccs_vaccinated_multi <- vaccinated_prescribed_multi %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated_multi <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated_multi
)

cat("```\n", paste(capture.output(print(
  sccs_result_vaccinated_multi
)), collapse = "\n"), "\n```")
```

Zde je opět riziko ve všech případech vyšší s rostoucí tendencí v čase. Statisticky významné jsou téměř všechny výsledky vyjma prvního okna.

## Poměrné riziko předpisů neočkovaných

```{r, results = 'asis'}
unvaccinated_prescribed_multi <- prescriptions %>%
  filter(
    vaccinated == "Bez vakcinace",
    presc_date >= as.Date("2021-06-23") - days(365),
    presc_date <= as.Date("2021-06-23") + days(365)
  ) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = as.Date("2021-06-23"),
    event_date = presc_date,
    observation_start_date = as.Date("2021-06-23") - days(365),
    observation_end_date = as.Date("2021-06-23") + days(365),
    drug_form = tolower(drug_form),
    inj_or_inf = str_detect(drug_form, "injekční|infuzní")
  ) %>%
  arrange(person_id, event_date) %>%
  group_by(person_id) %>%
  mutate(keep = {
    keep_vec <- logical(n())
    next_window_start <- as.Date(NA)
    
    for (i in seq_along(event_date)) {
      if (inj_or_inf[i]) {
        if (is.na(next_window_start) || event_date[i] > next_window_start) {
          keep_vec[i] <- TRUE
          next_window_start <- event_date[i] + 10
        } else {
          keep_vec[i] <- FALSE
        }
      } else {
        keep_vec[i] <- TRUE
      }
    }
    keep_vec
  }) %>%
  filter(keep) %>%
  ungroup() %>%
  select(-keep, -drug_form, -inj_or_inf)

sccs_unvaccinated_multi <- unvaccinated_prescribed_multi %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated_multi <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated_multi
)

cat("```\n", paste(capture.output(print(
  sccs_result_unvaccinated_multi
)), collapse = "\n"), "\n```")
```

U neočkované populace dochází k menšímu výkyvu a riziko po vakcinaci je stabilnější. I v tomto případě je ale vždy vyšší.

## Porovnání poměrného rizika

```{r}
coef_unvax <- sccs_result_unvaccinated_multi$coefficients
conf_unvax <- sccs_result_unvaccinated_multi$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated_multi$coefficients
conf_vax <- sccs_result_vaccinated_multi$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Unvaccinated")
df_vax <- df_vax %>% mutate(group = "Vaccinated")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(is.infinite(end_days),
                        paste0(start_days, "+"),
                        paste0(start_days, "-", end_days))

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high),
    width = 0.2,
    position = position_dodge(width = 0.6)
  ) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(x = "Období expozice (dny)", y = "Poměr rizik (HR)", title = "Porovnání SCCS: očkovaní vs neočkovaní") +
  theme_minimal()
```

Všeobecný trend vykazuje podobné známky jako trend prvopředpisů. K "výměně pozic" dochází ale už ve druhém sledovaném období (tedy 30-89 dní od vakcinace).

```{r}
vax_df <- combined %>%
  filter(group == "Vaccinated") %>%
  rename_with( ~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Unvaccinated") %>%
  rename_with( ~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high),
                width = 0.2,
                color = "blue") +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "red") +
  labs(title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)", x = "Období expozice", y = "Rozdíl v log(HR)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Porovnání log(HR) opět potvrzuje zjištění z předchozího grafu s rostoucím vyšším rizikem pro očkované ke konci.

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(
    did_results,
    data.frame(
      term = term,
      period_label = period_label,
      logHR_vax = logHR_vax,
      logHR_unvax = logHR_unvax,
      DiD_logHR = DiD_logHR,
      DiD_SE = DiD_SE,
      Z = Z,
      P_value = P_value
    )
  )
}

did_results %>%
  transmute(
    Období = period_label,
    `log(HR) Vakcinace` = logHR_vax,
    `log(HR) Bez vakcinace` = logHR_unvax,
    `DiD log(HR)` = DiD_logHR,
    p_value = P_value
  ) %>%
  kable(format = "html", caption = "Porovnání rizik (SCCS) očkovaných a neočkovaných") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

Jediný statisticky významný výsledek je pro poslední sledované období s vyšší mírou rizika pro očkované.