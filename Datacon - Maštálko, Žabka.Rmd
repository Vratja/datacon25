---
title: "Datacon - Analýza předpisovosti kortikoidsteroidů podle vakcinace na COVID-19"
author: "Samuel Maštálko, Vratislav Žabka"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 3
    number_sections: true
    theme: cerulean
    highlight: tango
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,          
  message = FALSE,     
  warning = FALSE,     
  results = 'hide',
  out.width = "100%"
)
```

```{r, echo = FALSE}
rm(list=ls(all=TRUE))
gc()
library(dplyr)
library(lubridate)
library(ggplot2)
library(data.table)
library(survminer)
library(survival)
library(duckdb)
library(tidyr)
library(SCCS)
library(stringr)
library(scales)
library(forecast)
library(changepoint)
library(purrr)
library(kableExtra)
library(viridisLite)
library(pheatmap)

con <- dbConnect(duckdb::duckdb(), dbdir = "data/datacon25.duckdb")
#dbDisconnect(con, shutdown = TRUE)
```

Jako vstupní zdroje dat byla použita již transformovaná data od zdravotních pojišťoven ČPZP a OZP upravená do datábázového formátu a uložena v lokální [DuckDB](https://duckdb.org/) databázi. Vstupní soubory byly očištěny o předpisy skupiny `L04`, které by eventuelně mohly sloužit k samostatné analýze, ale nedají se jednoznačně označit jako substituty kortikoidsteroidů.

Během vyhodnocování byli vždy vybráni pouze ti klienti, u kterých máme jistotu, že jsou pojištěni po celé sledované období. Pokud by noví klienti nebyli vyfiltrováni, hrozilo by výrazné zkreslení prvopředpisů a zkreslení celkového trendu způsobené fluktuací. Pokud klient v průběhu sledování zemřel, je bráno datum úmrtí jako datum konce pojištění. V případě dlouhodobého vyhodnocování jsou tedy vybráni klienti s počátkem pojištění před rokem 2015 a bez konce pojištění. Pro krátkodobé vyhodnocení (SCCS) byli vybráni klienti, kteří měli platné pojištění minimálně +- 365 dní od rozhodného data (vrchol vakcinace dané kohorty plus jeden týden).

Věk klienta je počítán k roku 2021, pokud není uvedeno jinak (např. [U výpočtu rizika prvopředpisu podle věku](#first-presc-by-age)).

Jako očkovaní klienti byli vybráni ti s alespoň jedním záznamem o vakcinaci a jako datum vakcinace bylo zvoleno datum první dávky.

Předpisy injekcí / infuzí byly agregovány do jednoho předpisu pouze u krátkodobé analýzy (SCCS). V ostatních případech sledujeme buď celkový trend (kde je výkyv v počtu předpisů způsobený větším množstvím injekcí také jeden z možných výsledků) nebo prvopředpisy (kde je množství irelevantní).

Při posuzování časových řad pomocí ETS modelu (příp. pomocí STL s lineární regresí) je posuzován nastavený trend do roku 2020 proti reálnému průběhu po tomto roce. Cíl tohoto přístupu je identifikovat, jestli měl COVID-19 nějaký vliv na celkový trend a případně, v jaké skupině dochází k největší odchylce.

V rámci analýz dlouhodobého dopadu jsou porovnávána data 2018-2020 proti datům z let 2022 a 2023. Smysl tohoto přístupu je odhalit, jestli měl COVID-19 (a potažmo očkování) nějaký vliv na období po relativním uklidnění. Data z let 2020 a 2021 jsou také vyřazena z důvodu nestability a výrazných sezónních propadů.

Pro dlouhodobé dopady byly použity 3 metriky, které je možné i částečně vyhodnotit vedle sebe. Vždy je bráno v úvahu, že pokud dochází k měření určitého stavu, musí mít všichni stejnou příležitost k dosažení daného stavu. Pro konkrétní metriky tedy:

* Prvopředpisovost: Data z počátku měření vykazují jako prvopředpis v zásadě každý předpis. To je samozřejmě chybný odhad a tedy jsou ze všech prvopředpisových metrik vyjmuty roky 2015 a 2016. Zároveň pokud je míra prvopředpisovosti stále identická, tak celkový úhrn prvopředpisů v čase klesá (nikdo nemůže dostat prvopředpis dvakrát). Z toho důvodu je prvopředpisovost vždy počítaná jako počet prvopředpisů na 1000 dosud nepředepisovaných osob.

* Multipředpisovost: Namísto celkového úhrnu předpisů je počítán poměr osob s více než jedním předpisem za zvolené období (měsíc nebo rok) na 1000 předepisovaných osob. Tento přístup umožní nejen vysledovat samotnou míru zvýšení či snížení, ale i odhadnout o jaký typ léčby jde.

Smysl by dávalo měřit i celkový počet předpisů na 1000 osob všeobecně a počty unikátních osob v daném období. Na obojí má ale výrazný vliv retence (tedy stav, kdy předepsaný klient dostává předpisy i ve všech dalších sledovaných časových intervalech) a vzhledem k tomu, že analýza je postavená na uzavřené skupině, kde nedochází k žádné fluktuaci klientů, tak by bylo nutné obě tyto metriky očistit o přirozenou míru udržení (kterou nelze jednoznačně odhadnout) a celkově by takové měření bylo náročné na interpretaci.

Krátkodobá analýza aplikuje metodu SCCS na prvopředpisy a veškeré předpisy. Smysl tohoto přístupu je odhalit bezprostřední rizika vakcinace a z pohledu celé analýzy je tento postup nejdůležitějším pro posouzení i z toho důvodu, že v kratším časovém horizontu lze předpokládat nižší vliv zavádějících proměnných způsobených časem.

Kontrolní součty z pohledu dlouhodobého sledování: 

* Počet očkovaných jedinců u jednotlivých pojišťoven: OZP `433 923` ČPZP `646 862`
* Počet neočkovaných jedinců bez předpisu u jednotlivých pojišťoven: OZP `106 160` ČPZP `248 729`
* Počet předpisů kortikoidů ve věkové skupině 31-50 let: `671 453`
* Počet očkovaných 31-50 let: `358 346`
* Počet předpisů pro očkované 31-50 let pro roky 2020-2022: `251 194` (včetně L04), `176 973` (H02)
* Počet neplatných záznamů: Neplatné záznamy jsou filtrovány samostaně na úrovni výpočtů a SQL dotazů. Například při analýze formy podání bylo nalezeno 56 záznamů s datem předpisu, ale s prázdnou formou podání.
* Počet prvopředpisů pro roky 2020-2022: `145 195` (včetně L04), `144 793` (H02)

# Celkový přehled

## Předpisy
```{r}
prescriptions <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.force AS strength,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN cpzp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'

                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.strength,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN ozp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN ozp_drugs_catalog d ON p.presc_id = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                          ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         vacc_yearmonth = floor_date(vacc_date, unit = "month"),
         presc_yearmonth = floor_date(presc_date, unit = "month"),
         vaccinated = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         sex = ifelse(sex == "Z", "F", sex),
         first_presc_flag = ifelse(!is.na(presc_date) & first_presc_date == presc_date,1,0)) %>%
mutate(age_class = case_when(
    age_2021 >= 5 & age_2021 <= 11 ~ "5-11",
    age_2021 >= 12 & age_2021 <= 15 ~ "12-15",
    age_2021 >= 16 & age_2021 <= 29 ~ "16-29",
    age_2021 >= 30 & age_2021 <= 34 ~ "30-34",
    age_2021 >= 35 & age_2021 <= 39 ~ "35-39",
    age_2021 >= 40 & age_2021 <= 44 ~ "40-44",
    age_2021 >= 45 & age_2021 <= 49 ~ "45-49",
    age_2021 >= 50 & age_2021 <= 54 ~ "50-54",
    age_2021 >= 55 & age_2021 <= 59 ~ "55-59",
    age_2021 >= 60 & age_2021 <= 64 ~ "60-64",
    age_2021 >= 65 & age_2021 <= 69 ~ "65-69",
    age_2021 >= 70 & age_2021 <= 79 ~ "70-79",
    age_2021 >= 80 ~ "80+",
    TRUE ~ NA_character_
  ),
  age_class = factor(age_class, levels = c(
    "5-11", "12-15", "16-29", "30-34", "35-39", "40-44",
    "45-49", "50-54", "55-59", "60-64", "65-69", "70-79", "80+"
  ))
)
```

### Vývoj počtu předpisů v čase

Na první pohled je viditelná odchylka od trendu během roku 2020 a následný strmější nárůst. Zároveň je také zřejmá vyšší míra předpisovosti u žen. Nižší počet předpisů u neočkované populace je jednoduše vysvětlitelný nižším počtem neočkovaných a pravděpodobně i jiným přístupem k prevenci.

```{r}
total_presc_by_month <- prescriptions %>%
  filter(!is.na(presc_yearmonth)) %>%
  group_by(presc_yearmonth) %>%
  summarise(total_prescriptions = n()) %>%
  ungroup()

ggplot(total_presc_by_month, aes(x = presc_yearmonth, y = total_prescriptions)) +
  geom_line(color = "steelblue", linewidth = 1, alpha = 0.6) +
  stat_smooth(method = "loess", span = 0.3, se = TRUE, linewidth = 1.5, color = "firebrick") +
  scale_x_date(
    date_labels = "%Y",
    date_breaks = "1 year",
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  labs(
    title = "Celkový úhrn předpisů",
    x = "Rok",
    y = "Počet předpisů"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(color = "black", size = 12, face = "bold"),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5)
  )
```


```{r}
grouped_presc <- prescriptions %>%
  filter(!is.na(presc_yearmonth)) %>%
  group_by(presc_yearmonth, sex, vaccinated) %>%
  summarise(total_prescriptions = n()) %>%
  ungroup()

ggplot(grouped_presc, aes(x = presc_yearmonth, y = total_prescriptions,
                         color = vaccinated, linetype = sex)) +
  geom_vline(xintercept = as.numeric(as.Date("2020-12-01")), linetype = "dotted", color = "gray70", linewidth = 0.4) +
  geom_line(linewidth = 1, alpha = 0.8) +
  stat_smooth(method = "loess", span = 0.3, se = TRUE, linewidth = 1.5, aes(color = vaccinated), linetype = "solid") +
  scale_x_date(
    date_labels = "%Y",
    date_breaks = "1 year",
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  scale_color_manual(values = c("Vakcinace" = "darkgreen", "Bez vakcinace" = "firebrick")) +
  labs(
    title = "Předpisy podle pohlaví a vakcinace",
    x = "Rok",
    y = "Počet předpisů",
    color = "Vakcinace",
    linetype = "Pohlaví"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(color = "black", size = 12, face = "bold"),
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5)
  )
```

### Riziko prvopředpisu podle věku
<a name="first-presc-by-age"></a>

Zde ze zřejmých důvodů není použit věk v roce 2021, ale věk v roce prvopředpisu. Riziko je počítané jako podíl prvopředpisů na počet osob v daném věku, které ještě žádný předpis neměly. Vyřazené jsou prvopředpisy v roce 2015 a 2016, které budou pravděpodobně vykazovat vysokou chybovost u lidí předepisovaných sezónně. Distribuce z logických důvodů (nemáme k dispozici veškerá historická data pro každého klienta) částečně kopíruje populační křivku, výsledek je tedy nutné brát s jistou rezervou.

```{r}
first_presc_dynamic_age <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                          ") %>%
  mutate(first_presc_yearmonth = floor_date(first_presc_date, unit = "month"),
         sex = ifelse(sex == "Z", "F", sex),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         age_at_presc = year(first_presc_date) - birthyear)

obs_start <- 2017
obs_end <- 2023
max_age <- 80


filtered_data <- first_presc_dynamic_age %>%
  mutate(
    year_of_presc = year(first_presc_date),
    age_of_presc = year_of_presc - birthyear,
    age_at_start = obs_start - birthyear,
    age_at_end = obs_end - birthyear
  ) %>%
  filter(age_at_end >= 0) %>%   
  filter(age_at_start <= max_age)

age_seq <- 0:max_age

at_risk_by_age <- lapply(age_seq, function(a) {
  n <- filtered_data %>%
    filter(is.na(age_of_presc) | age_of_presc > a) %>%
    n_distinct(.$client_id)
  data.frame(age = a, n_at_risk = n)
}) %>%
  bind_rows()

first_presc_by_age <- filtered_data %>%
  filter(!is.na(age_of_presc), year(first_presc_date) >= obs_start) %>%
  count(age = age_of_presc, name = "n_first_presc") %>%
  filter(age <= max_age)

age_analysis <- left_join(at_risk_by_age, first_presc_by_age, by = "age") %>%
  mutate(
    n_first_presc = replace_na(n_first_presc, 0),
    prop_first_presc = n_first_presc / n_at_risk
  )

ggplot(age_analysis, aes(x = age, y = prop_first_presc * 1000)) +
  geom_line(color = "steelblue") +
  geom_point(aes(color = n_first_presc)) +
  labs(
    title = "Riziko prvopředpisu podle věku",
    x = "Věk",
    y = "Počet prvopředpisů na 1000 osob bez předpisu",
    color = "Počet prvopředpisů"
  ) +
  theme_minimal()
```

## Vakcinace

```{r}
assign_age_class <- function(birthyear) {
  age <- 2021 - birthyear
  
  cut(
    age,
    
    breaks = c(-Inf, 4, 11, 15, 29, 34, 39, 44, 49, 54, 59, 64, 69, 79, Inf),
    labels = c(
      "<5",
      "5-11",
      "12-15",
      "16-29",
      "30-34",
      "35-39",
      "40-44",
      "45-49",
      "50-54",
      "55-59",
      "60-64",
      "65-69",
      "70-79",
      "80+"
    ),
    right = TRUE,
    ordered_result = TRUE
  )
}

vaccination_first_shot_by_birthyear <- dbGetQuery(con,
                                "
                                SELECT DISTINCT
                                v.date,
                                c.birthyear,
                                COUNT(DISTINCT v.client_id) OVER (
                                PARTITION BY v.date, c.birthyear) AS vaccinated_total_in_day,
                                'OZP' AS ins_company
                                FROM ozp_vaccinations v
                                LEFT JOIN ozp_clients c ON v.client_id = c.client_id
                                LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                                WHERE
                                v.event_order = 1
                                AND i.ins_start_date < '2020-01-01' AND i.ins_end_date > '2023-01-01'
                                
                                UNION
                                
                                SELECT DISTINCT
                                v.date,
                                c.birthyear,
                                COUNT(DISTINCT v.client_id) OVER (
                                PARTITION BY v.date, c.birthyear) AS vaccinated_total_in_day,
                                'CPZP' AS ins_company
                                FROM cpzp_vaccinations v
                                LEFT JOIN cpzp_clients c ON v.client_id = c.client_id
                                LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                                WHERE
                                v.event_order = 1
                                AND i.ins_start_date < '2020-01-01' AND i.ins_end_date > '2023-01-01'
                                "
) %>%
  group_by(date, birthyear) %>%
  summarise(vaccinated_total_in_day = sum(vaccinated_total_in_day, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(age_class = assign_age_class(birthyear)) %>%
  filter(age_class != "<5")

pop_by_age_class <- dbGetQuery( con,
                                     "
                                     SELECT DISTINCT
                                     birthyear,
                                     COUNT(DISTINCT c.client_id) OVER (PARTITION BY c.birthyear) AS clients_count,
                                     'OZP' AS ins_company
                                     FROM ozp_clients c
                                     LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                                     WHERE i.ins_start_date < '2020-01-01' AND i.ins_end_date > '2023-01-01'
                                     
                                     UNION
                                     
                                     SELECT DISTINCT
                                     birthyear,
                                     COUNT(DISTINCT c.client_id) OVER (PARTITION BY c.birthyear) AS clients_count,
                                     'CPZP' AS ins_company
                                     FROM cpzp_clients c
                                     LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                                     WHERE i.ins_start_date < '2020-01-01' AND i.ins_end_date > '2023-01-01'
                                     "
) %>%
  group_by(birthyear) %>%
  summarise(clients_count = sum(clients_count, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(age_class = assign_age_class(birthyear)) %>%
  group_by(age_class) %>%
  summarise(population = sum(clients_count, na.rm = TRUE),
            .groups = "drop") %>%
  filter(age_class != "<5")

vaccination_start_date <- pop_by_age_class %>%
  select(age_class) %>%
  arrange(desc(age_class)) %>%
  mutate(vaccination_start_date =
           as.Date(
             c(
               "2021-01-15",
               "2021-03-01",
               "2021-04-14",
               "2021-04-23",
               "2021-04-28",
               "2021-05-05",
               "2021-05-10",
               "2021-05-17",
               "2021-05-24",
               "2021-05-26",
               "2021-06-04",
               "2021-07-01",
               "2021-12-13"
             )
           ))
```

Věkové kategorie jsou pro účely sledování proočkovanosti rozřazeny podle harmonogramu zahájení vakcinace. V některých případech byla část populace vakcinovaná dříve, pokud bylo zpřístupnění zahájeno na základě jiného kritéria než věkového (např. personál zdravotnických zařízení). Tyto věkové kategorie jsou následně použité i později při detailních analýzách.

```{r, results = 'asis'}
vaccination_start_date_cz <- vaccination_start_date %>% filter(age_class != "<5")
colnames(vaccination_start_date_cz) <- c("Věková kategorie", "Datum zpřístupnění vakcinace")

vaccination_start_date_cz %>%
  kable("html", caption = "Harmonogram zahájení vakcinace") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = TRUE)
```

### Proočkovanost populace

Je zřejmé, že každá věková kategorie se chovala v přístupu k očkování jinak. Patrný trend je v logice "Čím starší populace, tím vyšší proočkovanost".

```{r}
vaccinated_first_shot_cumulative_ratio <- vaccination_first_shot_by_birthyear %>%
  group_by(age_class, date) %>%
  summarise(
    vaccinated_in_day = sum(vaccinated_total_in_day, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(age_class, date) %>%
  group_by(age_class) %>%
  mutate(cumulative_vaccinated = cumsum(vaccinated_in_day)) %>%
  ungroup() %>%
  inner_join(pop_by_age_class, by = "age_class") %>%
  mutate(vaccinated_ratio = cumulative_vaccinated / population)

ggplot(
  vaccinated_first_shot_cumulative_ratio %>%
    filter(date <= as.Date("2022-01-01")),
  aes(x = date, y = vaccinated_ratio, color = age_class)
) +
  geom_line(size = 1) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Kumulativní proočkovanost dle první dávky vakcíny",
    x = "Datum",
    y = "Pročkovanost",
    color = "Věková kategorie"
  ) +
  theme_minimal()
```

```{r}
vaccination_cumulative_relative <- vaccinated_first_shot_cumulative_ratio %>%
  left_join(vaccination_start_date, by = "age_class") %>%
  mutate(days_prior_to_vaccination_start_date = as.integer(date - vaccination_start_date))

vaccination_cumulative_relative %>%
  filter(date <= as.Date("2022-01-01")) %>%
  ggplot(aes(x = days_prior_to_vaccination_start_date, y = vaccinated_ratio, color = age_class)) +
  geom_line(size = 1) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Kumulativní proočkovanost",
    subtitle = "Podle doby od zahájení vakcinace pro danou kategorii",
    x = "Dnů od zahájení vakcinace",
    y = "Proočkovanost",
    color = "Věková kategorie"
  ) +
  theme_minimal(base_size = 13)
```

```{r, fig.height = 7}
vaccinated_weekly_smooth <- vaccinated_first_shot_cumulative_ratio %>%
  filter(age_class != "5-11") %>%
  arrange(age_class, date) %>%
  group_by(age_class) %>%
  mutate(
    vaccinated_7d_avg = zoo::rollmean(
      vaccinated_in_day / population,
      k = 7,
      fill = NA,
      align = "right"
    )
  ) %>%
  ungroup() %>%
  left_join(vaccination_start_date, by = "age_class") 

ggplot(
  vaccinated_weekly_smooth %>%
    filter(date <= as.Date("2022-01-01")),
  aes(x = date, y = vaccinated_7d_avg)
) +
  geom_line(color = "steelblue", size = 0.6) +
  geom_vline(aes(xintercept = vaccination_start_date), color = "red", linetype = "dashed", size = 0.5) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~ age_class, scales = "free_y") +
  labs(
    title = "Sedmidenní průměr denní vakcinace",
    subtitle = "S počátkem vakcinace (červená)",
    x = "Datum",
    y = "% Vakcinováno"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

### Eukleidovská vzdálenost proočkovanosti podle věku

Na základě míry kumulativní proočkovanosti podle doby od zahájení vakcinace lze spočítáním eukleidovských vzdáleností efektivně rozřadit věkové kategorie do širších kohort. Tyto kohorty lze později využít u analýz, které vyžadují větší množství dat (např. SCCS).

Výrazný rozdíl u skupiny `5-11` je způsoben tím, že očkování bylo zpřístupněno později a sledované období končí v roce 2022.

```{r}
wide_corr_data <- vaccination_cumulative_relative %>%
  select(age_class,
         days_prior_to_vaccination_start_date,
         vaccinated_ratio) %>%
  pivot_wider(names_from = age_class, values_from = vaccinated_ratio)

mat <- wide_corr_data %>% select(-days_prior_to_vaccination_start_date) %>% as.matrix()
dist_mat <- dist(t(mat), method = "euclidean")
dist_mat_full <- as.matrix(dist_mat)

color_palette <- viridis(100)

pheatmap(
  dist_mat_full,
  color = color_palette,
  display_numbers = TRUE,
  number_color = "black",
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  fontsize_number = 8,
  fontsize = 10,
  angle_col = 45,
  legend = TRUE,
  legend_breaks = seq(0, max(dist_mat_full), length.out = 5),
  legend_labels = round(seq(0, max(dist_mat_full), length.out = 5), 2),
  border_color = "grey60"
)
```

# Porovnání změny trendu po roce 2020

Je nutné vzít v úvahu fakt, že samotný čas je jako prediktor obecně nedostatečný a výsledky tohoto pozorování slouží spíše k účelům nasměrování k dalšímu zkoumání.

## Počet předpisů bez kategorizace

Pro předpověď vývoje dat po roce 2020 na základě předchozích dat byla použita metoda [ets](https://www.rdocumentation.org/packages/forecast/versions/8.24.0/topics/ets) R knihovny [forecast](https://www.rdocumentation.org/packages/forecast/versions/8.24.0).

K jednoduše vysvětlitelnému propadu dochází na začátku roku 2020 a poté k nárůstu oproti očekávaným hodnotám, který nelze vysvětlit jen vyvážením předchozího lokálního extrému. Zajímavostí je, že sezónní minima jsou předpovězena s vysokou přesností a k největším odchylkám dochází u sezónních maxim.



```{r}
prescriptions_clean <- prescriptions %>%
  filter(!is.na(presc_date)) %>%
  mutate(presc_date = as.Date(presc_date)) %>%
  arrange(presc_date) %>%
  filter(presc_date >= as.Date("2015-01-01") & presc_date <= as.Date("2023-12-31")) %>%
  mutate(count = 1)  


monthly_data <- prescriptions_clean %>%
  mutate(month = floor_date(presc_date, "month")) %>%
  group_by(month) %>%
  summarise(prescriptions = sum(count), .groups = 'drop')
```

```{r}
train_data <- monthly_data %>% filter(month < as.Date("2020-01-01"))
test_data  <- monthly_data %>% filter(month >= as.Date("2020-01-01"))


ts_train <- ts(train_data$prescriptions, start = c(2015, 1), frequency = 12)


fit <- ets(ts_train)


n_ahead <- nrow(test_data)
forecast_result <- forecast(fit, h = n_ahead)


comparison <- test_data %>%
  mutate(
    predicted = forecast_result$mean,
    residual = prescriptions - predicted
  )
```

```{r}
ggplot() +
  geom_line(data = monthly_data, aes(x = month, y = prescriptions), color = "blue", size = 1, alpha = 0.6) +
  geom_line(data = comparison, aes(x = month, y = predicted), color = "red", size = 1, linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "dotted") +
  labs(title = "Realita vs predikované hodnoty (ETS)",
       x = "Datum", y = "Počet předpisů")
```

```{r}
ggplot(comparison, aes(x = month, y = residual)) +
  geom_line(color = "steelblue", size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Odchylky 2020+", x = "Datum", y = "Odchylka")
```

Pro otestování významnosti změny úhrnu byl proveden t-test mezi průměrnými odchylkami od ETS modelu pro data před a po roce 2020. Rozdíl je statisticky významný.

```{r, results = 'asis'}
res_train <- residuals(fit)
res_test <- test_data$prescriptions - as.numeric(forecast_result$mean)

residuals_df <- bind_rows(
  tibble(month = train_data$month, residual = res_train, period = "train"),
  tibble(month = test_data$month, residual = res_test, period = "test")
)


ttest <- t.test(
  residuals_df$residual[residuals_df$period == "train"],
  residuals_df$residual[residuals_df$period == "test"]
)

cat("```\n", paste(capture.output(ttest), collapse = "\n"), "\n```")
```

## Počet předpisů podle pohlaví a vakcinace

Pro analýzu užších skupin byla použita drobně odlišná metodika. V první iteraci je postup téměř identický jako v původním případu. Pro analýzu samotného trendu jsou ale data nejprve očištěna o sezónnost a šum pomocí metody [stl](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/stl) a poté linearizována prostou lineární regresí. Tu lze zaprvé porovnat s očištěnými daty pro zjištění kvality modelu a zadruhé je změna trendu jednoduše patrná porovnáním sklonu každé z přímek.

Pro evaluaci odchylek je u neočištěných dat použito relativní RMSE (`rRMSE`), které je spočítáno jako RMSE po roce 2020 vydělené aritmetickým průměrem průběhu do roku 2020. To poté znázorňuje relativní odchylku od původních dat.

U druhého přístupu umožňuje linerání regrese i vyhodnocení kvality modelu. Toho je docíleno výpočtem koeficientu determinace pro data do roku 2022 (`r_squared`) a p-hodnoty samotného modelu (`p_value_lm`).

```{r}
analyze_group <- function(df, group_id, group_type) {
  monthly_data <- df %>%
    mutate(month = floor_date(presc_date, "month")) %>%
    group_by(month) %>%
    summarise(prescriptions = sum(count), .groups = 'drop') %>%
    arrange(month)

  train_data <- monthly_data %>% filter(month < as.Date("2020-01-01"))
  test_data  <- monthly_data %>% filter(month >= as.Date("2020-01-01"))

  if (nrow(train_data) < 24 || nrow(test_data) < 12) {
    return(NULL)
  }

  train_records <- df %>% filter(presc_date < as.Date("2020-01-01")) %>% nrow()

  ts_train <- ts(train_data$prescriptions, start = c(year(min(train_data$month)), month(min(train_data$month))), frequency = 12)

 fit <- tryCatch(ets(ts_train, model = "ZZM"), error = function(e) NULL)
  if (is.null(fit)) return(NULL)

  forecast_result <- forecast(fit, h = nrow(test_data))
  residuals_train <- residuals(fit)
  residuals_test <- test_data$prescriptions - as.numeric(forecast_result$mean)

  ttest <- t.test(residuals_train, residuals_test)
  rmse_train <- sqrt(mean(residuals_train^2))
  rmse <- sqrt(mean(residuals_test^2))
  p_train <- residuals(fit)
  
  mean_train <- mean(train_data$prescriptions)
  rrmse <- rmse / mean_train

  plot_data <- bind_rows(
    train_data %>% mutate(predicted = as.numeric(fitted(fit))),
    test_data %>% mutate(predicted = as.numeric(forecast_result$mean))
  ) %>%
    mutate(group = group_id, group_type = group_type)

  tibble(
    group = group_id,
    group_type = group_type,
    train_records = train_records,
    rmse_train = rmse_train,
    rmse = rmse,
    rrmse = rrmse,
    t_stat = ttest$statistic,
    p_value = ttest$p.value,
    mean_train_resid = mean(residuals_train),
    mean_test_resid = mean(residuals_test),
    plot_data = list(plot_data)
  )
}

analyze_group_trend <- function(df, group_id, group_type) {
  monthly_data <- df %>%
    mutate(month = floor_date(presc_date, "month")) %>%
    group_by(month) %>%
    summarise(prescriptions = sum(count), .groups = "drop") %>%
    arrange(month)

  if (nrow(monthly_data) < 36) return(NULL)

  ts_full <- ts(monthly_data$prescriptions,
                start = c(year(min(monthly_data$month)), month(min(monthly_data$month))),
                frequency = 12)
  
  stl_fit <- stl(ts_full, s.window = "periodic", robust = TRUE)
  trend_full <- stl_fit$time.series[, "trend"]

  trend_df <- tibble(
    month = monthly_data$month,
    trend = as.numeric(trend_full)
  ) %>%
    mutate(
      time_index = 1:n(),
      post_2020 = month >= as.Date("2020-01-01")
    )
  
  pre_df <- filter(trend_df, !post_2020)
  post_df <- filter(trend_df, post_2020)


  lm_pre <- lm(trend ~ time_index, data = pre_df)
  lm_post <- lm(trend ~ time_index, data = post_df)


  lm_pre_summary <- summary(lm_pre)
  pre_p_value <- lm_pre_summary$coefficients[2, 4]
  pre_r_squared <- lm_pre_summary$r.squared


  post_df <- post_df %>%
    mutate(
      extrapolated_pre_trend = predict(lm_pre, newdata = post_df),
      actual_post_trend = predict(lm_post, newdata = post_df),
      residuals = actual_post_trend - extrapolated_pre_trend
    )


  rmse_post <- sqrt(mean(post_df$residuals^2))
  mean_pre_trend <- mean(pre_df$trend)
  rrmse_post <- rmse_post / mean_pre_trend

  ttest <- t.test(post_df$residuals)

  trend_df <- trend_df %>%
    mutate(
      pre_fit = predict(lm_pre, newdata = trend_df),
      post_fit = if_else(post_2020, predict(lm_post, newdata = trend_df), NA_real_)
    )

  tibble(
    group = group_id,
    group_type = group_type,
    n_records = nrow(df),
    slope_pre = coef(lm_pre)["time_index"],
    slope_post = coef(lm_post)["time_index"],
    p_value_pre = pre_p_value,
    r_squared_pre = pre_r_squared,
    rmse_post = rmse_post,
    rrmse_post = rrmse_post,
    mean_residual = mean(post_df$residuals),
    t_stat = ttest$statistic,
    p_value = ttest$p.value,
    plot_data = list(trend_df)
  )
}
```

```{r}
results_vacc <- prescriptions_clean %>%
  filter(!is.na(vaccinated)) %>%
  group_by(vaccinated) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$vaccinated)
    analyze_group(df = filter(prescriptions_clean, vaccinated == group_val), 
                  group_id = group_val, 
                  group_type = "Vaccination")
  }) %>%
  compact() %>%
  bind_rows()

results_sex <- prescriptions_clean %>%
  filter(!is.na(sex)) %>%
  group_by(sex) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$sex)
    analyze_group(df = filter(prescriptions_clean, sex == group_val), 
                  group_id = group_val, 
                  group_type = "Sex")
  }) %>%
  compact() %>%
  bind_rows()

results_all <- bind_rows(results_vacc, results_sex) %>%
  arrange(p_value)

plot_data_all <- results_all %>%
  unnest(plot_data, names_sep = "_")
```


ETS model vykazuje největší rozdíl u nevakcinované skupiny a u mužů. T-test rozdílu odchylek je v obou případech statisticky významný.

```{r, results = 'asis'}
results_all %>%
  mutate(Skupina = group, RMSE = rmse, rRMSE = rrmse) %>%
  select(
    Skupina, RMSE, rRMSE, t_stat, p_value
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (ETS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(plot_data_all, aes(x = plot_data_month)) +
  geom_line(aes(y = plot_data_prescriptions), color = "blue") +
  geom_line(aes(y = plot_data_predicted), color = "red", linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "dotted") +
  facet_wrap(~ paste(plot_data_group_type, plot_data_group, sep = ": "), scales = "free_y") +
  labs(
    title = "Realita vs Předpověď (ETS)",
    subtitle = "Modrá = Realita, Červená = Předpověď",
    x = "Datum", y = "Počet předpisů"
  ) +
  theme_minimal()

```

Linearizovaný trend vykazuje nárůst od předpokladu ve všech kategoriích. Největší rozdíl je opět patrný u skupiny neočkovaných a mužů. U nevakcinované populace je nutné vzít v úvahu velmi nízký koeficient determinace a tedy i nízké prediktivní schopnosti samotného modelu.

```{r}
results_vacc <- prescriptions_clean %>%
  filter(!is.na(vaccinated)) %>%
  group_by(vaccinated) %>%
  group_split() %>%
  map(~ analyze_group_trend(.x, group_id = unique(.x$vaccinated), group_type = "Vaccinated")) %>%
  compact() %>%
  bind_rows()

results_sex <- prescriptions_clean %>%
  filter(!is.na(sex)) %>%
  group_by(sex) %>%
  group_split() %>%
  map(~ analyze_group_trend(.x, group_id = unique(.x$sex), group_type = "Sex")) %>%
  compact() %>%
  bind_rows()

results_all <- bind_rows(results_vacc, results_sex)

plot_data_all <- results_all %>%
  unnest(plot_data)
```

```{r, results = 'asis'}
results_all %>%
  mutate(Skupina = group, RMSE = rmse_post, rRMSE = rrmse_post, r_squared = r_squared_pre, p_value_diff = p_value, p_value_lm = p_value_pre) %>%
  select(
    Skupina, RMSE, rRMSE, p_value_lm, r_squared
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (linearizovaný trend)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(plot_data_all, aes(x = month)) +
  geom_line(aes(y = trend), color = "black", size = 0.8) +               
  geom_line(aes(y = pre_fit), color = "blue", size = 1.2, linetype = "dashed") +   
  geom_line(aes(y = post_fit), color = "red", size = 1.2, linetype = "dashed") +   
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "solid", color = "gray40") +
  facet_wrap(~ paste(group_type, group, sep = ": "), scales = "free_y") +
  labs(
    title = "Linearizované trendy v předpisovosti",
    subtitle = "Modrá = Linearizovaný trend do 2020; Červená = Linearizovaný trend po 2020",
    x = "Month",
    y = "Počet předpisů"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Počet předpisů podle věkové kategorie

Pro porovnání věkových kategorií byla použita stejná metodika jako u skupin podle vakcinace a pohlaví.

```{r}
results_age <- prescriptions_clean %>%
  filter(!is.na(age_class)) %>%
  group_by(age_class) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$age_class)
    analyze_group(df = filter(prescriptions_clean, age_class == group_val), 
                  group_id = group_val, 
                  group_type = "Age Class")
  }) %>%
  compact() %>%
  bind_rows()

results_age <- results_age %>%
  arrange(group)

plot_data_age <- results_age %>%
  unnest(plot_data, names_sep = "_")
```

K největšímu relativnímu rozdílu dochází u skupin `5-11`, `12-15` a `16-29`. To částečně vysvětluje i předchozí porovnání, kde největší rozdíl vykazovala skupina nevakcinovaných. Rozdíl reziduál je však významný jen u skupiny `16-29`. Skupiny `60-64` a `65-69` vykazují také signifikantní odchylku od očekávaných hodnot.

```{r, results = 'asis'}
results_age %>%
  mutate(Skupina = group, RMSE = rmse, rRMSE = rrmse) %>%
  select(
    Skupina, RMSE, rRMSE, t_stat, p_value
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (ETS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r, fig.height = 15}
ggplot(plot_data_age, aes(x = plot_data_month)) +
  geom_line(aes(y = plot_data_prescriptions), color = "blue") +
  geom_line(aes(y = plot_data_predicted), color = "red", linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "dotted") +
  facet_wrap(~ plot_data_group, scales = "free_y", ncol = 2) +
  labs(
    title = "Realita vs Předpověď (ETS)",
    subtitle = "Modrá = Realita, Červená = Předpověď",
    x = "Datum", y = "Počet předpisů"
  ) +
  theme_minimal()

```

```{r}
results_age <- prescriptions_clean %>%
  filter(!is.na(age_class)) %>%
  group_by(age_class) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$age_class)
    analyze_group_trend(df = filter(prescriptions_clean, age_class == group_val), 
                  group_id = group_val, 
                  group_type = "Age Class")
  }) %>%
  compact() %>%
  bind_rows()

results_age <- results_age %>%
  arrange(group)

plot_data_age <- results_age %>%
  unnest(plot_data)
```

Porovnání linearizovaných trendů víceméně potvrzuje některé předpoklady nalezené v předchozí analýze. Bohužel mladší skupiny (pod 15 let) mají natolik výrazné výkyvy i po očištění o sezónnost, že není možné jejich průběh linearizovat s vysokým koeficientem determinace. Skupina `16-29` již nevykazuje tak výraznou odchylku od předpokladu a u starší populace vykazuje výrazný rozdíl jen `65-69`.

```{r, results = 'asis'}
results_age %>%
  mutate(Skupina = group, RMSE = rmse_post, rRMSE = rrmse_post, r_squared = r_squared_pre, p_value_diff = p_value, p_value_lm = p_value_pre) %>%
  select(
    Skupina, RMSE, rRMSE, p_value_lm, r_squared
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (linearizovaný trend)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r, fig.height = 15}
ggplot(plot_data_age, aes(x = month)) +
  geom_line(aes(y = trend), color = "black", size = 0.8) +               
  geom_line(aes(y = pre_fit), color = "blue", size = 1.2, linetype = "dashed") +   
  geom_line(aes(y = post_fit), color = "red", size = 1.2, linetype = "dashed") +   
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "solid", color = "gray40") +
  facet_wrap(~ group, scales = "free_y", ncol = 2) +
  labs(
    title = "Linearizované trendy v předpisovosti",
    subtitle = "Modrá = Linearizovaný trend do 2020; Červená = Linearizovaný trend po 2020",
    x = "Month",
    y = "Počet předpisů"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Tato úvodní analýza poskytla vhodný startovací bod pro následné zkoumání konkrétních věkových kohort. Konkrétní skupiny vybrané pro další zkoumání tedy jsou: `12-15` z důvodu největšího výkyvu (skupina je ale bohužel natolik malá, že pravděpodobně nebude možné dojít k relevantním závěrům), `16-29`, `30-39` a `40-59`. Skupina `5-11` je vyřazena z několika důvodů. Prvním je nižší proočkovanost a druhým je fakt, že nejmladší populace této skupiny je na začátku dlouhodobého meření buď nenarozená nebo čerstvě na světě a může zde probíhat mnoho výkyvů. Skupina `60-69` by jistě také poskytla zajímavé výsledky, ale z časových důvodů a z důvodu zadání soutěže (orientace především na mladší populaci) byla prozatím také vyřazena.

# Metodika detailní analýzy

Detailní analýza je rozdělená na dvě části. Dlouhodobou a krátkodobou. Zatímco dlouhodobá analýza porovnává trendy v období před covidem (<2020) vs po covidu (>=2022), tak krátkodobá analýza sleduje efekty v horizontu jednoho roku od vakcíny s porovnáním stejně dlouhého období před vakcinací.

Pokud dochází k výkyvu celkové předpisovosti, tak musí zákonitě docházet i ve výkyvu buď v prvopředpisovosti, multipředpisovosti nebo obojím. Tyto dvě metriky jsou v dlouhodobé analýze měřené na 1000 osob v riziku, aby byly alespoň částečně porovnatelné. Pro prvopředpisovost tedy počet prvopředpisů na 1000 dosud nepředepsaných osob a pro multipředpisovost poměr multipředpisovaných osob v daném období na 1000 předpisovaných osob (období jsou roční a měsíční). Zároveň je také sledovaná míra retence (tedy kolik procent prvopředepisovaných bylo předepsaných i v následujícíh letech). Z těchto naměřených hodnot je následně vypočten poměr po vs před (a t-test na rozdíl průměrných hodnot) a statistická významnost rozdílu mezi očkovanými a neočkovanými je vyhodnocena pomocí p-hodnoty  pro `postCOVID:vaccinated` lineárního modelu `log(RatePer1000) ~ postCOVID * vaccinated`, kde proměnné `postCOVID` a `vaccinated` nabývají hodnot pouze 1 a 0.

Pro krátkodobé efekty je použita metoda [SCCS](https://cran.r-project.org/web/packages/SCCS/SCCS.pdf), konkrétně tedy `standardsccs()`. Očkovaní a neočkovaní jsou zde porovnáni s vlastní baseline 365 dní před vakcinací a následně jsou posouzena rizika prvopředpisů a předpisů celkem po vakcíně. Rizika jsou následně porovnána mezi očkovanými a neočkovanými. V případě neočkovaných je datum vakcinace nastaveno jako rozhodné datum v dané skupině. Skupina očkovaných vybraná pro analýzu je podle vakcinace (první dávka) +- 7 dní od rozhodného data. Do analýzy jsou oproti všem ostatním přístupům zahrnuti klienti, kteří byli pojištěni po dobu +- jednoho roku od vakcinace (v ostatních přístupech jsou zahrnuti klienti pojištěni minimálně po celých 8 let) a multipředpisy injekcí / infuzí v rozsahu 10 dnů jsou evidovány jako pouze jeden předpis, aby měla každá událost zhruba stejnou váhu. Období po podání vakcíny byla nastavena jako 0-29, 30-89, 90-179, 180-269 a 270-365 dní. Kratší intervaly bohužel často vykazovaly nižší množství dat a tedy insignifikantní výsledky. Skupiny `16-29` a `30-39` zde byly sloučeny do jedné z důvodu nízké relevance výstupů u samostatné evaluace. Pro testování rozdílů mezi skupinami byl použit Waldův test na rozdíl `log(Hazard Ratio)` v rámci DiD analýzy.

```{r}
age_cohorts <- vaccination_start_date %>%
  arrange(age_class)

age_cohorts <- age_cohorts[2:9 , ]

age_cohorts <- age_cohorts %>%
  mutate(
      cohort = c(rep("12-15", 1), rep("16-39", 3), rep("40-59", 4))
  )


vaccination_peaks <- vaccinated_first_shot_cumulative_ratio %>%
  inner_join(age_cohorts, by = "age_class") %>%
  group_by(cohort, date) %>%
  summarise(vaccinated_in_day = sum(vaccinated_in_day, na.rm = TRUE), .groups = "drop") %>%
  arrange(cohort, date) %>%
  group_by(cohort) %>%
  mutate(vaccinated_in_day_ma7 = zoo::rollmean(vaccinated_in_day, k = 7, fill = NA, align = "right")) %>%
  ungroup()

peak_dates <- vaccination_peaks %>%
  group_by(cohort) %>%
  filter(vaccinated_in_day == max(vaccinated_in_day, na.rm = TRUE)) %>%
  slice(1) %>% 
  ungroup() %>%
  select(cohort, peak_date = date) %>%
  mutate(decisive_date = peak_date + days(7))
```

Z důvodu vrcholu očkování krátce po zahájení je rozhodné datum nastavené o 7 dní později než datum vrcholu.

```{r, results = 'asis'}
age_cohorts %>%
  group_by(cohort) %>%
  summarise(vaccination_start_date = max(vaccination_start_date)) %>%
  left_join(peak_dates, by = "cohort") %>%
  transmute(Kohorta = cohort, `Datum zahájení vakcinace` = vaccination_start_date, `Vrchol vakcinace` = peak_date, `Rozhodné datum` = decisive_date) %>%
  kable(format = "html", caption = "Zahájení a vrcholy vakcinace dle kohorty") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```
  
```{r}
ggplot(vaccination_peaks, aes(x = date, y = vaccinated_in_day_ma7)) +
  geom_line(color = "steelblue") +
  facet_wrap(~ cohort, scales = "free_y") +
  geom_vline(data = peak_dates, aes(xintercept = as.numeric(decisive_date)), color = "red", linetype = "dashed") +
  labs(title = "Sedmidenní průměr denní vakcinace a vrcholy vakcinace",
       x = "Datum", y = "Vakcinovaných za den") +
  theme_minimal()
```

# Věková kategorie 12-15

## Dlouhodobý efekt

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
prescriptions <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.force AS strength,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN cpzp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 12 AND 15
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.strength,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN ozp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN ozp_drugs_catalog d ON p.presc_id = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 12 AND 15
                          ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         vacc_yearmonth = floor_date(vacc_date, unit = "month"),
         presc_yearmonth = floor_date(presc_date, unit = "month"),
         vaccinated = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         sex = ifelse(sex == "Z", "F", sex),
         first_presc_flag = ifelse(!is.na(presc_date) & first_presc_date == presc_date,1,0))
```

### Distribuce věku a pohlaví

Ačkoliv je věková distribuce podle vakcinace mírně odlišná, neměla by mít výrazný vliv z pohledu rozdílných rizik podle stáří.

```{r}
unique_clients <- prescriptions %>%
  filter(!is.na(age_2021), !is.na(sex), !is.na(vaccinated)) %>%
  distinct(client_id, .keep_all = TRUE)  

age_data <- unique_clients %>%
  group_by(vaccinated, age_2021) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Age",
         value = as.character(age_2021)) %>%
  ungroup()

sex_data <- unique_clients %>%
  group_by(vaccinated, sex) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Sex",
         value = sex) %>%
  ungroup()
```

```{r}
ggplot(unique_clients, aes(x = age_2021, fill = factor(vaccinated))) +
  geom_histogram(aes(y = after_stat(density)), position = "identity", alpha = 0.4, binwidth = 1) +
  scale_fill_brewer(palette = "Set1", name = "Vaccinated") +
  scale_x_continuous(breaks = seq(floor(min(unique_clients$age)), ceiling(max(unique_clients$age)), by = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Věkové rozložení podle statusu vakcinace",
    x = "Věk", y = "%",
    fill = "Vakcinace"
  ) +
  theme_minimal()
```

```{r}
ggplot(sex_data, aes(x = sex, y = prop, color = vaccinated, group = vaccinated)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Pohlaví podle vakcinace",
    x = "Pohlaví",
    y = "%",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

### Předpověď vs realita

ETS model vyhodnocuje rozdíl v nastaveném trendu zejména u ženské a neočkované populace. Tyto rozdíly po vs před rokem 2020 jsou statisticky významné.

```{r}
prescriptions_clean <- prescriptions %>%
  filter(!is.na(presc_date)) %>%
  mutate(presc_date = as.Date(presc_date)) %>%
  arrange(presc_date) %>%
  filter(presc_date >= as.Date("2015-01-01") & presc_date <= as.Date("2023-12-31")) %>%
  mutate(count = 1)  

results_vacc <- prescriptions_clean %>%
  filter(!is.na(vaccinated)) %>%
  group_by(vaccinated) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$vaccinated)
    analyze_group(df = filter(prescriptions_clean, vaccinated == group_val), 
                  group_id = group_val, 
                  group_type = "Vaccination")
  }) %>%
  compact() %>%
  bind_rows()

results_sex <- prescriptions_clean %>%
  filter(!is.na(sex)) %>%
  group_by(sex) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$sex)
    analyze_group(df = filter(prescriptions_clean, sex == group_val), 
                  group_id = group_val, 
                  group_type = "Sex")
  }) %>%
  compact() %>%
  bind_rows()

results_all <- bind_rows(results_vacc, results_sex) %>%
  arrange(p_value)

plot_data_all <- results_all %>%
  unnest(plot_data, names_sep = "_")
```

```{r, results = 'asis'}
results_all %>%
  mutate(Skupina = group, RMSE = rmse, rRMSE = rrmse) %>%
  select(
    Skupina, RMSE, rRMSE, t_stat, p_value
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (ETS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(plot_data_all, aes(x = plot_data_month)) +
  geom_line(aes(y = plot_data_prescriptions), color = "blue") +
  geom_line(aes(y = plot_data_predicted), color = "red", linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "dotted") +
  facet_wrap(~ paste(plot_data_group_type, plot_data_group, sep = ": "), scales = "free_y") +
  labs(
    title = "Realita vs Předpověď (ETS)",
    subtitle = "Modrá = Realita, Červená = Předpověď",
    x = "Datum", y = "Počet předpisů"
  ) +
  theme_minimal()

```

### Prvopředpisovost

Všeobecná prvopředpisovost je na celé populaci mírně vyšší v období po covidu.

```{r}
first_presc <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 12 AND 15
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 12 AND 15
                          ") %>%
  mutate(first_presc_yearmonth = floor_date(first_presc_date, unit = "month"),
         sex = ifelse(sex == "Z", "F", sex),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         age_2021 = 2021 - birthyear)

monthly_first_presc <- first_presc %>%
  count(first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(first_presc_yearmonth) %>%
  mutate(
    cum_new_presc = cumsum(new_prescriptions),  
    total_population = nrow(first_presc),
    at_risk_population = total_population - lag(cum_new_presc, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )

monthly_clean <- monthly_first_presc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

ttest <- t.test(rate ~ period_group, data = monthly_clean)
```

```{r}
ggplot(monthly_first_presc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000)) +
  geom_line(color = "steelblue", size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Počet prvopředpisů na 1000 nepředepsaných klientů", limits = c(0, 2)) +
  labs(
    title = "Prvopředpisovost v čase",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
cat("```\n", paste(capture.output(ttest), collapse = "\n"), "\n```")
```


```{r}
total_by_vacc <- first_presc %>%
  count(vacc_status, name = "total_population")

monthly_by_vacc <- first_presc %>%
  count(vacc_status, first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(vacc_status, first_presc_yearmonth) %>%
  group_by(vacc_status) %>%
  mutate(
    cum_prescriptions = cumsum(new_prescriptions),
    total_population = total_by_vacc$total_population[match(vacc_status, total_by_vacc$vacc_status)],
    at_risk_population = total_population - lag(cum_prescriptions, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  ungroup() %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )
  
monthly_by_vacc_clean <- monthly_by_vacc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

first_presc_table <- monthly_by_vacc_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(rate ~ period_group)$p.value,
    mean_before = mean(rate[period_group == "Pre-COVID"]),
    mean_after = mean(rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```

Prvopředpisovost po covidu vykazuje nárůst u obou kategorií, v případě očkovaných však vyšší a statisticky významný.

```{r, results = 'asis'}
first_presc_table %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before * 1000, `Průměr po` = mean_after * 1000, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání prvopředpisovosti v čase podle vakcinace") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(monthly_by_vacc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000, color = vacc_status)) +
  geom_line(size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Prescriptions per 1,000 at-risk clients", limits = c(0, 2.5)) +
  labs(
    title = "Prvopředpisovost v čase podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

DiD model ovšem statisticky významný rozdíl mezi skupinami nepotvrzuje (p hodnota pro interakci vaccinated:post_covid).

```{r, results = 'asis'}
monthly_rates <- monthly_by_vacc %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID")) %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(first_presc_yearmonth >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid)

did_model <- lm(log(rate * 1000) ~ vaccinated * post_covid, data = monthly_rates)

cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Multipředpisovost

#### Míra retence (meziroční multipředpisovost)

```{r}
presc_id_counts <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'CPZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 12 AND 15
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'OZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 12 AND 15
                          ")%>%
  mutate(presc_year = as.integer(format(as.Date(presc_date), "%Y")),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"))

monthly_unique_clients <- presc_id_counts %>%
  mutate(yearmonth = floor_date(presc_date, unit = "month")) %>%
  distinct(client_id, yearmonth, vacc_status) %>%
  count(yearmonth, vacc_status, name = "n_unique_clients")

presc_years <- presc_id_counts %>%
  mutate(
    presc_year = year(presc_date)
  ) %>%
  distinct(client_id, first_presc_year, presc_year, vacc_status) %>%
  filter(first_presc_year >= 2017, first_presc_year <= 2023)


retention_data <- presc_years %>%
  mutate(year_offset = presc_year - first_presc_year) %>%
  filter(year_offset >= 0)


retention_summary <- retention_data %>%
  group_by(first_presc_year, year_offset, vacc_status) %>%
  summarise(n_clients = n_distinct(client_id), .groups = "drop")


cohort_sizes <- retention_data %>%
  filter(year_offset == 0) %>%
  group_by(first_presc_year, vacc_status) %>%
  summarise(cohort_size = n_distinct(client_id), .groups = "drop")


retention_summary <- retention_summary %>%
  left_join(cohort_sizes, by = c("first_presc_year", "vacc_status")) %>%
  mutate(retention_rate = n_clients / cohort_size)

retention_summary_filtered <- retention_summary %>%
  filter(year_offset > 0)
```

Vzhledem k tomu, že roční retence lze sledovat jen v několikaletém horizontu, nemáme dostatek relevantních dat pro posouzení vývoje po vs před covidem. Všeobecně je ale míra retence srovnatelná.

```{r}
ggplot(retention_summary_filtered, aes(x = year_offset, y = retention_rate, color = as.factor(first_presc_year))) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_color_viridis_d(name = "Rok prvopředpisu") +
  labs(
    title = "Retence (meziroční předpisovost) podle vakcinace",
    x = "Počet let od prvopředpisu",
    y = "Míra multipředpisovosti"
  ) +
  facet_wrap(~ vacc_status) +
  theme_minimal(base_size = 13)
```

#### Roční multipředpisovost

```{r, echo=FALSE}
multi_presc <- dbGetQuery(con,
                          "
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          ozp_prescriptions p
                          INNER JOIN ozp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 12 AND 15
                          INNER JOIN ozp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date IS NULL

                          
                          UNION
                          
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          cpzp_prescriptions p
                          INNER JOIN cpzp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 12 AND 15
                          INNER JOIN cpzp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date = '9999-12-31'
                          ")
```

```{r}
multi_presc_yearly <- multi_presc %>%
  mutate(year = year(date)) %>%
  filter(year > 2017)


multi_clients_yearly <- multi_presc_yearly %>%
  group_by(year, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_yearly <- multi_clients_yearly %>%
  group_by(year, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_yearly <- multi_summary_yearly %>%
  mutate(
    period_group = case_when(
      year < 2020 ~ "Pre-COVID",
      year > 2021 ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_yearly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before,
    .groups = "drop"
  )
```

V obou skupinách je možné sledovat nárůst. Ten však ani v jednom případě není statisticky významný. Zajímavé je však sledovat klesavou tendenci u neočkované populace mezi lety 2022 a 2023, zatímco u očkované populace je trend neustále rostoucí.

```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání roční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```

```{r}
ggplot(multi_summary_yearly, aes(x = year, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.6, alpha = 0.4) +
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +
  annotate("rect",
           xmin = 2020, xmax = 2021,
           ymin = -Inf, ymax = Inf,
           alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Roční multipředpisovost na 1000 předepsaných klientů") +
  scale_x_continuous(breaks = unique(multi_summary_yearly$year)) +
  labs(
    title = "Roční multipředpisovost podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Rok",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

Rozdíl v rozdílech nárůstů je také vysoko nad přijatelnou hladinou statistické významnosti.

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year >= 2022, 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

#### Měsíční multipředpisovost

```{r, echo=FALSE}
multi_presc <- multi_presc %>%
  mutate(year_month = floor_date(date, unit = "month"))

multi_clients_by_month <- multi_presc %>%
  group_by(year_month, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_monthly <- multi_clients_by_month %>%
  filter(year_month > "2017-12-31") %>%
  group_by(year_month, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_monthly <- multi_summary_monthly %>%
  mutate(
    period_group = case_when(
      year_month < as.Date("2020-01-01") ~ "Pre-COVID",
      year_month > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_monthly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```

Neočkovaná skupina vykazuje po covidovém období téměř 34% nárůst. Růst je také znatelný ve skupině očkovaných, ten však není statisticky signifikantní.

```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání měsíční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```


```{r}
ggplot(multi_summary_monthly, aes(x = year_month, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.5, alpha = 0.4) + 
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +  
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Měsíční multipředpisovost na 1000 předepsaných klientů") +
  labs(
    title = "Měsíční multipředpisovost podle vakcinačního statusu",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

Interakce vakcíny a post-covidového období nevykazuje známky statistické významnosti.

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year_month >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Způsob podání

Na první pohled je patrný trend zvyšování poměru injekcí a infuzí na úkor tablet. Injekce také mají všeobecně vyšší míru multipředpisovosti. To může částečně vysvětlovat všeobecně vyšší multipředpisovost v post-covidovém období. Otázkou je, zdali k nárůstu injekcí / infuzí dochází u dětí a mladistvých (s rostoucím věkem) přirozeně a je tedy možné vysvětlit změnu prostým stárnutím populace a nebo se jedná o dlouhodobu změnu.

```{r}
prescriptions <- prescriptions %>%
  mutate(
    drug_form_std = case_when(
      is.na(drug_form) ~ NA_character_,
      str_detect(drug_form, "tableta|Tableta") ~ "Tableta",
      str_detect(drug_form, "tobolka|Tobolka") ~ "Tobolka",
      str_detect(drug_form, "injekční|Injekční|infuzní|Infuzní") ~ "Injekce / Infuze",
      str_detect(drug_form, "č[íi]pek|Čípek") ~ "Čípek",
      str_detect(drug_form, "perorální roztok|Perorální roztok") ~ "Perorální roztok",
      TRUE ~ "Other"
    )
  )

prescriptions <- prescriptions %>%
  mutate(
    year = year(presc_date)
  )

ggplot(prescriptions %>% filter(!is.na(presc_date), !is.na(drug_form)), aes(x = factor(year), fill = drug_form_std)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Poměr způsobu podání v čase",
    x = "Rok",
    y = "%",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

```{r}
client_yearly_counts <- prescriptions %>%
  filter(!is.na(presc_date), !is.na(drug_form)) %>%
  group_by(client_id, year, drug_form_std) %>%
  summarise(presc_count = n(), .groups = "drop")

average_freq_per_year <- client_yearly_counts %>%
  group_by(year, drug_form_std) %>%
  summarise(avg_presc_per_client = mean(presc_count), .groups = "drop")

ggplot(average_freq_per_year, aes(x = factor(year), y = avg_presc_per_client, fill = drug_form_std)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Počet předpisů za rok na klienta dle způsobu podání",
    x = "Rok",
    y = "Průměrný počet předpisů na klienta",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

Poměr injekcí / infuzí na tablety v zásadě potvrzuje trend zobrazený v předchozím grafu.

```{r}
filtered_data <- prescriptions %>%
  mutate(
    drug_form_std = ifelse(is.na(drug_form_std), "Unknown", drug_form_std)
  ) %>%
  filter(
    drug_form_std %in% c("Injekce / Infuze", "Tableta"),
    !is.na(vaccinated),
    !is.na(presc_yearmonth)
  )

form_vax_counts <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated, drug_form_std) %>%
  summarise(n = n(), .groups = "drop")

month_totals <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated) %>%
  summarise(total = n(), .groups = "drop")

form_vax_ratios <- form_vax_counts %>%
  left_join(month_totals, by = c("presc_yearmonth", "vaccinated")) %>%
  mutate(ratio = n / total)

form_vax_ratios <- form_vax_ratios %>%
  mutate(group = paste(drug_form_std, ifelse(vaccinated == "Vakcinace", "Vakcinace", "Bez vakcinace"), sep = " - "))

ggplot(form_vax_ratios, aes(x = presc_yearmonth, y = ratio, color = group)) +
  geom_line(size = 0.6) +                   
  geom_smooth(se = FALSE, span = 0.3) +   
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_date(date_labels = "%Y",         
               date_breaks = "1 year",
               expand = c(0.01, 0)) +
  labs(
    title = "Poměr počtu předpisů podle způsobu podání a vakcinace",
    x = "Datum",
    y = "Poměr počtu předpisů",
    color = "Forma podání + Vakcinace"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
```

## Krátkodobý efekt

### Prvopředpisy

#### SCCS vakcinovaných

Bohužel je patrné, že pro relevantní zhodnocení rizika prvopředpisu je v očkované populaci `5-11` příliš málo záznamů. Jediný významný výsledek je v pátem období (tedy 270 - 365 dní od vakcinace). Podle tohoto výsledku je riziko více než dvojnásobné (ovšem na velmi širokém intervalu spolehlivosti).

```{r, results = 'asis'}
combined_vaccinated_prescribed <- dbGetQuery(con,
                                    "
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    'CPZP' as ins_company
                                    FROM cpzp_vaccinations v
                                    LEFT JOIN cpzp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.presc_order = 1
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-08-04' - INTERVAL '7 days'
                                                       AND DATE '2021-08-04' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    
                                    UNION
                                    
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    'OZP' AS ins_company
                                    FROM OZP_vaccinations v
                                    LEFT JOIN ozp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN ozp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.presc_order = 1
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-08-04' - INTERVAL '7 days'
                                                       AND DATE '2021-08-04' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    ") %>%
  mutate(client_id = row_number()) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_vaccinated <- combined_vaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_vaccinated)), collapse = "\n"), "\n```")
```

#### SCCS nevakcinovaných

Neočkovaná část populace vykazuje mnohem relevantnější výsledky (i z důvodu většího množství sledovaných osob).

```{r, results = 'asis'}
combined_unvaccinated_prescribed <- dbGetQuery(con,
                                               "
                                    SELECT
                                    p.client_id,
                                    DATE '2021-08-04' AS vaccination_date,
                                    p.date AS event_date,
                                    'CPZP' as ins_company
                                    FROM cpzp_prescriptions p
                                    LEFT JOIN cpzp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-08-04'- INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-08-04' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    AND p.date BETWEEN DATE '2021-08-04' - INTERVAL '1 year' AND DATE '2021-08-04' + INTERVAL '1 year'
                                    AND p.presc_order = 1
                                    AND c.n_vacc = 0
                                    
                                    UNION
                                    
                                    SELECT
                                    p.client_id,
                                    DATE '2021-08-04' AS vaccination_date,
                                    p.date AS event_date,
                                    'OZP' as ins_company
                                    FROM ozp_prescriptions p
                                    LEFT JOIN ozp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-08-04' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-08-04' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    AND p.date BETWEEN DATE '2021-08-04' - INTERVAL '1 year' AND DATE '2021-08-04' + INTERVAL '1 year'
                                    AND p.presc_order = 1
                                    AND c.n_vacc = 0

                                               ") %>%
  mutate(client_id = row_number()) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_unvaccinated <- combined_unvaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_unvaccinated)), collapse = "\n"), "\n```")
```

#### Porovnání rizik

Podle naměřených hodnot je riziko u očkovaných osob mírně nižší nebo srovnatelné až 180 dní od vakcinace, poté se naopak mírně zvýší. P-hodnoty rozdílů mezi skupinami jsou však ve všech případech vysoko nad akceptovatelnou úrovní (což je i mimo výpočet patrné z širokých intervalů spolehlivosti).

```{r}
coef_unvax <- sccs_result_unvaccinated$coefficients
conf_unvax <- sccs_result_unvaccinated$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated$coefficients
conf_vax <- sccs_result_vaccinated$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Bez Vakcinace")
df_vax <- df_vax %>% mutate(group = "Vakcinace")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(
  is.infinite(end_days),
  paste0(start_days, "+"),
  paste0(start_days, "-", end_days)
)

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2,
                position = position_dodge(width = 0.6)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Období expozice (dny)",
    y = "Poměr rizik (HR)",
    title = "Porovnání SCCS: očkovaní vs neočkovaní"
  ) +
  theme_minimal()
```

```{r}
vax_df <- combined %>%
  filter(group == "Vakcinace") %>%
  rename_with(~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Bez Vakcinace") %>%
  rename_with(~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.2, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)",
    x = "Období expozice",
    y = "Rozdíl v log(HR)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(did_results, data.frame(
    term = term,
    period_label = period_label,
    logHR_vax = logHR_vax,
    logHR_unvax = logHR_unvax,
    DiD_logHR = DiD_logHR,
    DiD_SE = DiD_SE,
    Z = Z,
    P_value = P_value
  ))
}

did_results %>%
  transmute(Období = period_label, `log(HR) Vakcinace` = logHR_vax, `log(HR) Bez vakcinace` = logHR_unvax, `DiD log(HR)` = DiD_logHR, p_value = P_value) %>%
  kable(format = "html", caption = "Porovnání rizik očkovaných a neočkovaných (SCCS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

### Předpisy celkem

#### SCCS vakcinovaných

U celkového počtu předpisů je výhoda ve větším množství záznamů a tedy i vyšší pravděpodobnosti, že některý z výsledků bude významný. To se bohužel u očkované skupiny nepotvrdilo a jediný signifikantní výsledek je opět v období 270 - 365 dní po vakcinaci.

```{r, results = 'asis'}
combined_vaccinated_prescribed <- dbGetQuery(con,
                                    "
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'CPZP' as ins_company
                                    FROM cpzp_vaccinations v
                                    LEFT JOIN cpzp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-08-04' - INTERVAL '7 days'
                                                       AND DATE '2021-08-04' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    
                                    UNION
                                    
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'OZP' AS ins_company
                                    FROM OZP_vaccinations v
                                    LEFT JOIN ozp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN ozp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    LEFT JOIN ozp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-08-04' - INTERVAL '7 days'
                                                       AND DATE '2021-08-04' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         drug_form = tolower(drug_form),
         inj_or_inf = str_detect(drug_form, "injekční|infuzní"))

injectable_infusional <- combined_vaccinated_prescribed %>%
  filter(inj_or_inf) %>%
  arrange(client_id, event_date) %>%
  group_by(client_id) %>%
  mutate(
    day_diff = as.numeric(difftime(event_date, lag(event_date, default = first(event_date)), units = "days")),
    new_window = is.na(day_diff) | day_diff > 10,
    window_id = cumsum(new_window)
  ) %>%
  group_by(client_id, window_id) %>%
  slice(1) %>%
  ungroup()

other_drugs <- combined_vaccinated_prescribed %>%
  filter(!inj_or_inf)

combined_vaccinated_prescribed <- bind_rows(injectable_infusional, other_drugs) %>%
  arrange(client_id, event_date) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_vaccinated <- combined_vaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_vaccinated)), collapse = "\n"), "\n```")
```

#### SCCS nevakcinovaných

Naopak u neočkované populace je díky výrazně většímu množství záznamů možné zhodnotit rizika s větší jistotou. Výsledek v zásadě říká, že po celou dobu od rozhodného data (vyjma prvního měsíce) je riziko zhruba jeden a půl násobné.

```{r, results = 'asis'}
combined_unvaccinated_prescribed <- dbGetQuery(con,
                                               "
                                    SELECT
                                    p.client_id,
                                    DATE '2021-08-04' AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'CPZP' as ins_company
                                    FROM cpzp_prescriptions p
                                    LEFT JOIN cpzp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-08-04' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-08-04' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    AND p.date BETWEEN DATE '2021-08-04' - INTERVAL '1 year' AND DATE '2021-08-04' + INTERVAL '1 year'
                                    AND c.n_vacc = 0
                                    
                                    UNION
                                    
                                    SELECT
                                    p.client_id,
                                    DATE '2021-08-04' AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'OZP' as ins_company
                                    FROM ozp_prescriptions p
                                    LEFT JOIN ozp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    LEFT JOIN ozp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-08-04' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-08-04' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 12 AND 15
                                    AND p.date BETWEEN DATE '2021-08-04' - INTERVAL '1 year' AND DATE '2021-08-04' + INTERVAL '1 year'
                                    AND c.n_vacc = 0

                                               ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         drug_form = tolower(drug_form),
         inj_or_inf = str_detect(drug_form, "injekční|infuzní"))

injectable_infusional <- combined_unvaccinated_prescribed %>%
  filter(inj_or_inf) %>%
  arrange(client_id, event_date) %>%
  group_by(client_id) %>%
  mutate(
    day_diff = as.numeric(difftime(event_date, lag(event_date, default = first(event_date)), units = "days")),
    new_window = is.na(day_diff) | day_diff > 10,
    window_id = cumsum(new_window)
  ) %>%
  group_by(client_id, window_id) %>%
  slice(1) %>%
  ungroup()

other_drugs <- combined_unvaccinated_prescribed %>%
  filter(!inj_or_inf)

combined_unvaccinated_prescribed <- bind_rows(injectable_infusional, other_drugs) %>%
  arrange(client_id, event_date) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_unvaccinated <- combined_unvaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_unvaccinated)), collapse = "\n"), "\n```")
```

#### Porovnání rizik

Rozdíl mezi riziky je všeobecně vyhodnocen jako menší pro očkovanou populaci. Ani jedno z porovnání však není statisticky významné.

```{r}
coef_unvax <- sccs_result_unvaccinated$coefficients
conf_unvax <- sccs_result_unvaccinated$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated$coefficients
conf_vax <- sccs_result_vaccinated$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Unvaccinated")
df_vax <- df_vax %>% mutate(group = "Vaccinated")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(
  is.infinite(end_days),
  paste0(start_days, "+"),
  paste0(start_days, "-", end_days)
)

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2,
                position = position_dodge(width = 0.6)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Období expozice (dny)",
    y = "Poměr rizik (HR)",
    title = "Porovnání SCCS: očkovaní vs neočkovaní"
  ) +
  theme_minimal()
```

```{r}
vax_df <- combined %>%
  filter(group == "Vaccinated") %>%
  rename_with(~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Unvaccinated") %>%
  rename_with(~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.2, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)",
    x = "Období expozice",
    y = "Rozdíl v log(HR)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(did_results, data.frame(
    term = term,
    period_label = period_label,
    logHR_vax = logHR_vax,
    logHR_unvax = logHR_unvax,
    DiD_logHR = DiD_logHR,
    DiD_SE = DiD_SE,
    Z = Z,
    P_value = P_value
  ))
}

did_results %>%
  transmute(Období = period_label, `log(HR) Vakcinace` = logHR_vax, `log(HR) Bez vakcinace` = logHR_unvax, `DiD log(HR)` = DiD_logHR, p_value = P_value) %>%
  kable(format = "html", caption = "Porovnání rizik (SCCS) očkovaných a neočkovaných") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

## Shrnutí

Z dlouhodobého hlediska je nárůst ve všech sledovaných kategoriích naprosto zřejmý. Rozdíl mezi očkovanou a neočkovanou populací však není možné prokázat ani v jednom případě. Změny ve způsobu podání (vyšší podíl injekcí a infuzí na úkor tablet) mohou částečně vysvětlit zvýšenou multipředpisovost, je však otázkou zdali se jedná o přirozený jev způsobený stárnutím populace a nebo je vliv jiný.

Co se týče vyhodnocení rizika v krátkodobém horizontu, trpí dataset na nedostatek relevantních dat. Ve sledovaných obdobích nebyl nalezen jediný statisticky významný rozdíl mezi očkovanou a neočkovanou populací.

# Věková kategorie 16-29
## Dlouhodobý efekt

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
prescriptions <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.force AS strength,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN cpzp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.strength,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN ozp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN ozp_drugs_catalog d ON p.presc_id = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                          ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         vacc_yearmonth = floor_date(vacc_date, unit = "month"),
         presc_yearmonth = floor_date(presc_date, unit = "month"),
         vaccinated = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         sex = ifelse(sex == "Z", "F", sex),
         first_presc_flag = ifelse(!is.na(presc_date) & first_presc_date == presc_date,1,0))
```

### Distribuce věku a pohlaví

I v této věkové kategorii jsou patrné rozdíly, výrazný rozdíl způsobený odlišnými riziky na základě věku by však ani zde neměl nastat.

```{r}
unique_clients <- prescriptions %>%
  filter(!is.na(age_2021), !is.na(sex), !is.na(vaccinated)) %>%
  distinct(client_id, .keep_all = TRUE)  

age_data <- unique_clients %>%
  group_by(vaccinated, age_2021) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Age",
         value = as.character(age_2021)) %>%
  ungroup()

sex_data <- unique_clients %>%
  group_by(vaccinated, sex) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Sex",
         value = sex) %>%
  ungroup()
```

```{r}
ggplot(unique_clients, aes(x = age_2021, fill = factor(vaccinated))) +
  geom_histogram(aes(y = after_stat(density)), position = "identity", alpha = 0.4, binwidth = 1) +
  scale_fill_brewer(palette = "Set1", name = "Vaccinated") +
  scale_x_continuous(breaks = seq(floor(min(unique_clients$age)), ceiling(max(unique_clients$age)), by = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Věkové rozložení podle statusu vakcinace",
    x = "Věk", y = "%",
    fill = "Vakcinace"
  ) +
  theme_minimal()
```

```{r}
ggplot(sex_data, aes(x = sex, y = prop, color = vaccinated, group = vaccinated)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Pohlaví podle vakcinace",
    x = "Pohlaví",
    y = "%",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

### Předpověď vs realita

```{r}
prescriptions_clean <- prescriptions %>%
  filter(!is.na(presc_date)) %>%
  mutate(presc_date = as.Date(presc_date)) %>%
  arrange(presc_date) %>%
  filter(presc_date >= as.Date("2015-01-01") & presc_date <= as.Date("2023-12-31")) %>%
  mutate(count = 1)  


results_vacc <- prescriptions_clean %>%
  filter(!is.na(vaccinated)) %>%
  group_by(vaccinated) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$vaccinated)
    analyze_group(df = filter(prescriptions_clean, vaccinated == group_val), 
                  group_id = group_val, 
                  group_type = "Vaccination")
  }) %>%
  compact() %>%
  bind_rows()

results_sex <- prescriptions_clean %>%
  filter(!is.na(sex)) %>%
  group_by(sex) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$sex)
    analyze_group(df = filter(prescriptions_clean, sex == group_val), 
                  group_id = group_val, 
                  group_type = "Sex")
  }) %>%
  compact() %>%
  bind_rows()

results_all <- bind_rows(results_vacc, results_sex) %>%
  arrange(p_value)

plot_data_all <- results_all %>%
  unnest(plot_data, names_sep = "_")
```

Výkyvy od předpokládaného trendu jsou zde ve všech skupinách. Vyjma vakcinované kategorie jsou také všechny statisticky významné.

```{r, results = 'asis'}
results_all %>%
  mutate(Skupina = group, RMSE = rmse, rRMSE = rrmse) %>%
  select(
    Skupina, RMSE, rRMSE, t_stat, p_value
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (ETS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(plot_data_all, aes(x = plot_data_month)) +
  geom_line(aes(y = plot_data_prescriptions), color = "blue") +
  geom_line(aes(y = plot_data_predicted), color = "red", linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "dotted") +
  facet_wrap(~ paste(plot_data_group_type, plot_data_group, sep = ": "), scales = "free_y") +
  labs(
    title = "Realita vs Předpověď (ETS)",
    subtitle = "Modrá = Realita, Červená = Předpověď",
    x = "Datum", y = "Počet předpisů"
  ) +
  theme_minimal()

```

### Prvopředpisovost

```{r}
first_presc <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                          ") %>%
  mutate(first_presc_yearmonth = floor_date(first_presc_date, unit = "month"),
         sex = ifelse(sex == "Z", "F", sex),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         age_2021 = 2021 - birthyear)

monthly_first_presc <- first_presc %>%
  count(first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(first_presc_yearmonth) %>%
  mutate(
    cum_new_presc = cumsum(new_prescriptions),  
    total_population = nrow(first_presc),
    at_risk_population = total_population - lag(cum_new_presc, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )

monthly_clean <- monthly_first_presc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

ttest <- t.test(rate ~ period_group, data = monthly_clean)
```

V porovnání před-covidového a po-covidového období došlo k jednoznačnému nárůstu prvopředpisovosti.

```{r}
ggplot(monthly_first_presc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000)) +
  geom_line(color = "steelblue", size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Počet prvopředpisů na 1000 osob bez předpisu", limits = c(0, 3)) +
  labs(
    title = "Prvopředpisovost v čase",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
cat("```\n", paste(capture.output(ttest), collapse = "\n"), "\n```")
```

```{r}
total_by_vacc <- first_presc %>%
  count(vacc_status, name = "total_population")

monthly_by_vacc <- first_presc %>%
  count(vacc_status, first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(vacc_status, first_presc_yearmonth) %>%
  group_by(vacc_status) %>%
  mutate(
    cum_prescriptions = cumsum(new_prescriptions),
    total_population = total_by_vacc$total_population[match(vacc_status, total_by_vacc$vacc_status)],
    at_risk_population = total_population - lag(cum_prescriptions, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  ungroup() %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )
  
monthly_by_vacc_clean <- monthly_by_vacc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

first_presc_table <- monthly_by_vacc_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(rate ~ period_group)$p.value,
    mean_before = mean(rate[period_group == "Pre-COVID"]),
    mean_after = mean(rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```

Rozdíly mezi skupinami jsou však nepatrné až téměř nulové. To také potvrzuje p-hodnota příslušného DiD modelu.

```{r, results = 'asis'}
first_presc_table %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before * 1000, `Průměr po` = mean_after * 1000, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání prvopředpisovosti v čase podle vakcinace") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(monthly_by_vacc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000, color = vacc_status)) +
  geom_line(size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Počet prvopředpisů na 1000 osob bez předpisu", limits = c(0, 3)) +
  labs(
    title = "Prvopředpisovost v čase podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
monthly_rates <- monthly_by_vacc %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID")) %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(first_presc_yearmonth >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid)

did_model <- lm(log(rate * 1000) ~ vaccinated * post_covid, data = monthly_rates)

cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Multipředpisovost

#### Míra retence (meziroční multipředpisovost)

```{r}
presc_id_counts <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'CPZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'OZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 16 AND 29
                          ")%>%
  mutate(presc_year = as.integer(format(as.Date(presc_date), "%Y")),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"))

monthly_unique_clients <- presc_id_counts %>%
  mutate(yearmonth = floor_date(presc_date, unit = "month")) %>%
  distinct(client_id, yearmonth, vacc_status) %>%
  count(yearmonth, vacc_status, name = "n_unique_clients")

presc_years <- presc_id_counts %>%
  mutate(
    presc_year = year(presc_date)
  ) %>%
  distinct(client_id, first_presc_year, presc_year, vacc_status) %>%
  filter(first_presc_year >= 2017, first_presc_year <= 2023)


retention_data <- presc_years %>%
  mutate(year_offset = presc_year - first_presc_year) %>%
  filter(year_offset >= 0)


retention_summary <- retention_data %>%
  group_by(first_presc_year, year_offset, vacc_status) %>%
  summarise(n_clients = n_distinct(client_id), .groups = "drop")


cohort_sizes <- retention_data %>%
  filter(year_offset == 0) %>%
  group_by(first_presc_year, vacc_status) %>%
  summarise(cohort_size = n_distinct(client_id), .groups = "drop")


retention_summary <- retention_summary %>%
  left_join(cohort_sizes, by = c("first_presc_year", "vacc_status")) %>%
  mutate(retention_rate = n_clients / cohort_size)

retention_summary_filtered <- retention_summary %>%
  filter(year_offset > 0)
```

Retence je všeobecně vyšší než u mladší populace a u očkované skupiny je zřejmá vyšší míra udržení "do dalších let". Reálné zhodnocení vlivu covidu však bude možné až v budoucnosti.

```{r}
ggplot(retention_summary_filtered, aes(x = year_offset, y = retention_rate, color = as.factor(first_presc_year))) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_color_viridis_d(name = "Rok prvopředpisu") +
  labs(
    title = "Retence (meziroční předpisovost) podle vakcinace",
    x = "Počet let od prvopředpisu",
    y = "Míra multipředpisovosti"
  ) +
  facet_wrap(~ vacc_status) +
  theme_minimal(base_size = 13)
```

#### Roční multipředpisovost

```{r, echo=FALSE}
multi_presc <- dbGetQuery(con,
                          "
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          ozp_prescriptions p
                          INNER JOIN ozp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 16 AND 29
                          INNER JOIN ozp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date IS NULL

                          
                          UNION
                          
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          cpzp_prescriptions p
                          INNER JOIN cpzp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 16 AND 29
                          INNER JOIN cpzp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date = '9999-12-31'
                          ")
```

```{r}
multi_presc_yearly <- multi_presc %>%
  mutate(year = year(date)) %>%
  filter(year > 2017)


multi_clients_yearly <- multi_presc_yearly %>%
  group_by(year, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_yearly <- multi_clients_yearly %>%
  group_by(year, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_yearly <- multi_summary_yearly %>%
  mutate(
    period_group = case_when(
      year < 2020 ~ "Pre-COVID",
      year > 2021 ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_yearly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before,
    .groups = "drop"
  )
```

V obou skupinách došlo k nárůstu od původního trendu s rozdílem toho, že v očkované populaci došlo nejprve k poklesu během covidu. Rozdíly mezi skupinami není možné vyhodnotit jako významné.

```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání roční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```

```{r}
ggplot(multi_summary_yearly, aes(x = year, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.6, alpha = 0.4) +
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +
  annotate("rect",
           xmin = 2020, xmax = 2021,
           ymin = -Inf, ymax = Inf,
           alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Roční multipředpisovost na 1000 předepsaných klientů") +
  scale_x_continuous(breaks = unique(multi_summary_yearly$year)) +
  labs(
    title = "Roční multipředpisovost podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Rok",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year >= 2022, 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

#### Měsíční multipředpisovost

```{r, echo=FALSE}
multi_presc <- multi_presc %>%
  mutate(year_month = floor_date(date, unit = "month"))

multi_clients_by_month <- multi_presc %>%
  group_by(year_month, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_monthly <- multi_clients_by_month %>%
  filter(year_month > "2017-12-31") %>%
  group_by(year_month, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_monthly <- multi_summary_monthly %>%
  mutate(
    period_group = case_when(
      year_month < as.Date("2020-01-01") ~ "Pre-COVID",
      year_month > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_monthly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```

Změny v měsíční předpisovosti v zásadě jen potvrzují předchozí sledování s tím rozdílem, že u očkované skupiny došlo jen k mírnému růstu. Ovšem v tomto případě je rozdíl mezi rozdíly statisticky signifikantní (interakce vaccinated:post_covid).

```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání měsíční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```


```{r}
ggplot(multi_summary_monthly, aes(x = year_month, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.5, alpha = 0.4) + 
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +  
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Měsíční multipředpisovost na 1000 předepsaných klientů") +
  labs(
    title = "Měsíční multipředpisovost podle vakcinačního statusu",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year_month >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Způsob podání

Vývoj zde jen potvrzuje trend nastolený v předchozí sledované skupině a tedy, že s rostoucím věkem se preferují injekce / infuze na úkor tablet.

```{r}
prescriptions <- prescriptions %>%
  mutate(
    drug_form_std = case_when(
      is.na(drug_form) ~ NA_character_,
      str_detect(drug_form, "tableta|Tableta") ~ "Tableta",
      str_detect(drug_form, "tobolka|Tobolka") ~ "Tobolka",
      str_detect(drug_form, "injekční|Injekční|infuzní|Infuzní") ~ "Injekce / Infuze",
      str_detect(drug_form, "č[íi]pek|Čípek") ~ "Čípek",
      str_detect(drug_form, "perorální roztok|Perorální roztok") ~ "Perorální roztok",
      TRUE ~ "Other"
    )
  )

prescriptions <- prescriptions %>%
  mutate(
    year = year(presc_date)
  )

ggplot(prescriptions %>% filter(!is.na(presc_date), !is.na(drug_form)), aes(x = factor(year), fill = drug_form_std)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Poměr způsobu podání v čase",
    x = "Rok",
    y = "%",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

```{r}
client_yearly_counts <- prescriptions %>%
  filter(!is.na(presc_date), !is.na(drug_form)) %>%
  group_by(client_id, year, drug_form_std) %>%
  summarise(presc_count = n(), .groups = "drop")

average_freq_per_year <- client_yearly_counts %>%
  group_by(year, drug_form_std) %>%
  summarise(avg_presc_per_client = mean(presc_count), .groups = "drop")

ggplot(average_freq_per_year, aes(x = factor(year), y = avg_presc_per_client, fill = drug_form_std)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Počet předpisů za rok na klienta dle způsobu podání",
    x = "Rok",
    y = "Průměrný počet předpisů na klienta",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

Při sledování poměru předpisů je zajímavé sledovat výkyv neočkované populace ve druhé polovině roku 2021. K tomuto výkyvu dochází u všech dospělých neočkovaných skupin a je způsoben jak snížením celkového množství injekcí, tak zvýšením celkového množství tablet. Může se jednat o vlivy covidových nařízení a částečné nepřístupnosti ambulantní léčby pro neočkovanou populaci.

```{r}
filtered_data <- prescriptions %>%
  mutate(
    drug_form_std = ifelse(is.na(drug_form_std), "Unknown", drug_form_std)
  ) %>%
  filter(
    drug_form_std %in% c("Injekce / Infuze", "Tableta"),
    !is.na(vaccinated),
    !is.na(presc_yearmonth)
  )

form_vax_counts <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated, drug_form_std) %>%
  summarise(n = n(), .groups = "drop")

month_totals <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated) %>%
  summarise(total = n(), .groups = "drop")

form_vax_ratios <- form_vax_counts %>%
  left_join(month_totals, by = c("presc_yearmonth", "vaccinated")) %>%
  mutate(ratio = n / total)

form_vax_ratios <- form_vax_ratios %>%
  mutate(group = paste(drug_form_std, ifelse(vaccinated == "Vakcinace", "Vakcinace", "Bez vakcinace"), sep = " - "))

ggplot(form_vax_ratios, aes(x = presc_yearmonth, y = ratio, color = group)) +
  geom_line(size = 0.6) +                   
  geom_smooth(se = FALSE, span = 0.3) +   
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_date(date_labels = "%Y",         
               date_breaks = "1 year",
               expand = c(0.01, 0)) +
  labs(
    title = "Poměr počtu předpisů podle způsobu podání a vakcinace",
    x = "Datum",
    y = "Poměr počtu předpisů",
    color = "Forma podání + Vakcinace"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
```

## Shrnutí

V rámci dlouhodobého vývoje jsou opět všechna rizika větší v době po covidu oproti době před covidem. Průběh očkovaných a neočkovaných je však srovnatelný. Jedinou výjimkou je měsíční multipředpisovost, kde očkovaní podléhají mírně nižšímu riziku. Poměry způsobu podání v zásadě kopírují trend nastavený v mladší kategorii - a tedy nárůst injekcí / infuzí na úkor tablet s jedinou výjimkou ve druhé polovině roku 2021, kde výrazně rostou tablety a klesají injekce / infuze.

Krátkodobá analýza je sloučená se skupinou 30-39 z důvodu nízké relevance výsledků.

# Věková kategorie 30-39
## Dlouhodobý efekt

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
prescriptions <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.force AS strength,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN cpzp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 30 AND 39
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.strength,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN ozp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN ozp_drugs_catalog d ON p.presc_id = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 30 AND 39
                          ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         vacc_yearmonth = floor_date(vacc_date, unit = "month"),
         presc_yearmonth = floor_date(presc_date, unit = "month"),
         vaccinated = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         sex = ifelse(sex == "Z", "F", sex),
         first_presc_flag = ifelse(!is.na(presc_date) & first_presc_date == presc_date,1,0))
```

### Distribuce věku a pohlaví

Demografické rozložení je v tomto případě mírně vyváženější než u mladší populace.

```{r}
unique_clients <- prescriptions %>%
  filter(!is.na(age_2021), !is.na(sex), !is.na(vaccinated)) %>%
  distinct(client_id, .keep_all = TRUE)  

age_data <- unique_clients %>%
  group_by(vaccinated, age_2021) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Age",
         value = as.character(age_2021)) %>%
  ungroup()

sex_data <- unique_clients %>%
  group_by(vaccinated, sex) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Sex",
         value = sex) %>%
  ungroup()
```

```{r}
ggplot(unique_clients, aes(x = age_2021, fill = factor(vaccinated))) +
  geom_histogram(aes(y = after_stat(density)), position = "identity", alpha = 0.4, binwidth = 1) +
  scale_fill_brewer(palette = "Set1", name = "Vaccinated") +
  scale_x_continuous(breaks = seq(floor(min(unique_clients$age)), ceiling(max(unique_clients$age)), by = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Věkové rozložení podle statusu vakcinace",
    x = "Věk", y = "%",
    fill = "Vakcinace"
  ) +
  theme_minimal()
```

```{r}
ggplot(sex_data, aes(x = sex, y = prop, color = vaccinated, group = vaccinated)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Pohlaví podle vakcinace",
    x = "Pohlaví",
    y = "%",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

### Předpověď vs realita

```{r}
prescriptions_clean <- prescriptions %>%
  filter(!is.na(presc_date)) %>%
  mutate(presc_date = as.Date(presc_date)) %>%
  arrange(presc_date) %>%
  filter(presc_date >= as.Date("2015-01-01") & presc_date <= as.Date("2023-12-31")) %>%
  mutate(count = 1)  


results_vacc <- prescriptions_clean %>%
  filter(!is.na(vaccinated)) %>%
  group_by(vaccinated) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$vaccinated)
    analyze_group(df = filter(prescriptions_clean, vaccinated == group_val), 
                  group_id = group_val, 
                  group_type = "Vaccination")
  }) %>%
  compact() %>%
  bind_rows()

results_sex <- prescriptions_clean %>%
  filter(!is.na(sex)) %>%
  group_by(sex) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$sex)
    analyze_group(df = filter(prescriptions_clean, sex == group_val), 
                  group_id = group_val, 
                  group_type = "Sex")
  }) %>%
  compact() %>%
  bind_rows()

results_all <- bind_rows(results_vacc, results_sex) %>%
  arrange(p_value)

plot_data_all <- results_all %>%
  unnest(plot_data, names_sep = "_")
```

Rozdíly očekávaného úhrnu předpisů jsou napříč všemi kategoriemi téměř identické.

```{r, results = 'asis'}
results_all %>%
  mutate(Skupina = group, RMSE = rmse, rRMSE = rrmse) %>%
  select(
    Skupina, RMSE, rRMSE, t_stat, p_value
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (ETS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(plot_data_all, aes(x = plot_data_month)) +
  geom_line(aes(y = plot_data_prescriptions), color = "blue") +
  geom_line(aes(y = plot_data_predicted), color = "red", linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "dotted") +
  facet_wrap(~ paste(plot_data_group_type, plot_data_group, sep = ": "), scales = "free_y") +
  labs(
    title = "Realita vs Předpověď (ETS)",
    subtitle = "Modrá = Realita, Červená = Předpověď",
    x = "Datum", y = "Počet předpisů"
  ) +
  theme_minimal()

```

### Prvopředpisovost

```{r}
first_presc <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 30 AND 39
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 30 AND 39
                          ") %>%
  mutate(first_presc_yearmonth = floor_date(first_presc_date, unit = "month"),
         sex = ifelse(sex == "Z", "F", sex),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         age_2021 = 2021 - birthyear)

monthly_first_presc <- first_presc %>%
  count(first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(first_presc_yearmonth) %>%
  mutate(
    cum_new_presc = cumsum(new_prescriptions),  
    total_population = nrow(first_presc),
    at_risk_population = total_population - lag(cum_new_presc, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )

monthly_clean <- monthly_first_presc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

ttest <- t.test(rate ~ period_group, data = monthly_clean)
```

Stejně jako u jiných věkových skupin zde došlo k významnému nárůstu prvopředpisovosti.

```{r}
ggplot(monthly_first_presc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000)) +
  geom_line(color = "steelblue", size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Počet prvopředpisů na 1000 osob bez předpisu", limits = c(0, 5)) +
  labs(
    title = "Prvopředpisovost v čase",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
cat("```\n", paste(capture.output(ttest), collapse = "\n"), "\n```")
```

```{r}
total_by_vacc <- first_presc %>%
  count(vacc_status, name = "total_population")

monthly_by_vacc <- first_presc %>%
  count(vacc_status, first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(vacc_status, first_presc_yearmonth) %>%
  group_by(vacc_status) %>%
  mutate(
    cum_prescriptions = cumsum(new_prescriptions),
    total_population = total_by_vacc$total_population[match(vacc_status, total_by_vacc$vacc_status)],
    at_risk_population = total_population - lag(cum_prescriptions, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  ungroup() %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )
  
monthly_by_vacc_clean <- monthly_by_vacc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

first_presc_table <- monthly_by_vacc_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(rate ~ period_group)$p.value,
    mean_before = mean(rate[period_group == "Pre-COVID"]),
    mean_after = mean(rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```

K tomuto nárůstu došlo napříč vakcinovanou i nevakcinovanou populací a rozdíly mezi populacemi nejsou významné.

```{r, results = 'asis'}
first_presc_table %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before * 1000, `Průměr po` = mean_after * 1000, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání prvopředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(monthly_by_vacc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000, color = vacc_status)) +
  geom_line(size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Počet prvopředpisů na 1000 osob bez předpisu", limits = c(0, 5)) +
  labs(
    title = "Prvopředpisovost v čase podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
monthly_rates <- monthly_by_vacc %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID")) %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(first_presc_yearmonth >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid)

did_model <- lm(log(rate * 1000) ~ vaccinated * post_covid, data = monthly_rates)

cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Multipředpisovost

#### Míra retence (meziroční multipředpisovost)

Zde je opět potvrzený trend vyšší míry oproti mladší populaci a také vyšší retence očkovaných jedinců.

```{r}
presc_id_counts <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'CPZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 30 AND 39
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'OZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 30 AND 39
                          ")%>%
  mutate(presc_year = as.integer(format(as.Date(presc_date), "%Y")),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"))

monthly_unique_clients <- presc_id_counts %>%
  mutate(yearmonth = floor_date(presc_date, unit = "month")) %>%
  distinct(client_id, yearmonth, vacc_status) %>%
  count(yearmonth, vacc_status, name = "n_unique_clients")

presc_years <- presc_id_counts %>%
  mutate(
    presc_year = year(presc_date)
  ) %>%
  distinct(client_id, first_presc_year, presc_year, vacc_status) %>%
  filter(first_presc_year >= 2017, first_presc_year <= 2023)


retention_data <- presc_years %>%
  mutate(year_offset = presc_year - first_presc_year) %>%
  filter(year_offset >= 0)


retention_summary <- retention_data %>%
  group_by(first_presc_year, year_offset, vacc_status) %>%
  summarise(n_clients = n_distinct(client_id), .groups = "drop")


cohort_sizes <- retention_data %>%
  filter(year_offset == 0) %>%
  group_by(first_presc_year, vacc_status) %>%
  summarise(cohort_size = n_distinct(client_id), .groups = "drop")


retention_summary <- retention_summary %>%
  left_join(cohort_sizes, by = c("first_presc_year", "vacc_status")) %>%
  mutate(retention_rate = n_clients / cohort_size)

retention_summary_filtered <- retention_summary %>%
  filter(year_offset > 0)
```

```{r}
ggplot(retention_summary_filtered, aes(x = year_offset, y = retention_rate, color = as.factor(first_presc_year))) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_color_viridis_d(name = "Rok prvopředpisu") +
  labs(
    title = "Retence (meziroční předpisovost) podle vakcinace",
    x = "Počet let od prvopředpisu",
    y = "Míra multipředpisovosti"
  ) +
  facet_wrap(~ vacc_status) +
  theme_minimal(base_size = 13)
```

#### Roční multipředpisovost

Během porovnání obou období dochází k mírnému nárůstu. Zde je ale nutné zmínit, že samotný průměr míry multipředpisovosti není vhodnou metrikou a to z důvodu stoupavého trendu až do roku 2020 a poté spíše konstantního průběhu pro očkovanou populaci. Rozdíly mezi skupinami jsou opět nevýznamné.

```{r, echo=FALSE}
multi_presc <- dbGetQuery(con,
                          "
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          ozp_prescriptions p
                          INNER JOIN ozp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 30 AND 39
                          INNER JOIN ozp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date IS NULL

                          
                          UNION
                          
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          cpzp_prescriptions p
                          INNER JOIN cpzp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 30 AND 39
                          INNER JOIN cpzp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date = '9999-12-31'
                          ")
```

```{r}
multi_presc_yearly <- multi_presc %>%
  mutate(year = year(date)) %>%
  filter(year > 2017)


multi_clients_yearly <- multi_presc_yearly %>%
  group_by(year, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_yearly <- multi_clients_yearly %>%
  group_by(year, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_yearly <- multi_summary_yearly %>%
  mutate(
    period_group = case_when(
      year < 2020 ~ "Pre-COVID",
      year > 2021 ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_yearly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before,
    .groups = "drop"
  )
```


```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání roční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```

```{r}
ggplot(multi_summary_yearly, aes(x = year, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.6, alpha = 0.4) +
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +
  annotate("rect",
           xmin = 2020, xmax = 2021,
           ymin = -Inf, ymax = Inf,
           alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Roční multipředpisovost na 1000 předepsaných klientů") +
  scale_x_continuous(breaks = unique(multi_summary_yearly$year)) +
  labs(
    title = "Roční multipředpisovost podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Rok",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year >= 2022, 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

#### Měsíční multipředpisovost

Měsíční multipředpisovost vykazuje mírně klesavou tendenci v období po covidu u nevakcinované populace a stoupaní u vakcinované. Rozdíly uvnitř skupin i mezi skupinami jsou však nevýznamné.

```{r, echo=FALSE}
multi_presc <- multi_presc %>%
  mutate(year_month = floor_date(date, unit = "month"))

multi_clients_by_month <- multi_presc %>%
  group_by(year_month, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_monthly <- multi_clients_by_month %>%
  filter(year_month > "2017-12-31") %>%
  group_by(year_month, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_monthly <- multi_summary_monthly %>%
  mutate(
    period_group = case_when(
      year_month < as.Date("2020-01-01") ~ "Pre-COVID",
      year_month > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_monthly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```


```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání měsíční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```


```{r}
ggplot(multi_summary_monthly, aes(x = year_month, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.5, alpha = 0.4) + 
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +  
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Měsíční multipředpisovost na 1000 předepsaných klientů") +
  labs(
    title = "Měsíční multipředpisovost podle vakcinačního statusu",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year_month >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Způsob podání

Poměry způsobu podání se oproti mladším skupinám srovnaly a vykazují zhruba stejné hodnoty.

```{r}
prescriptions <- prescriptions %>%
  mutate(
    drug_form_std = case_when(
      is.na(drug_form) ~ NA_character_,
      str_detect(drug_form, "tableta|Tableta") ~ "Tableta",
      str_detect(drug_form, "tobolka|Tobolka") ~ "Tobolka",
      str_detect(drug_form, "injekční|Injekční|infuzní|Infuzní") ~ "Injekce / Infuze",
      str_detect(drug_form, "č[íi]pek|Čípek") ~ "Čípek",
      str_detect(drug_form, "perorální roztok|Perorální roztok") ~ "Perorální roztok",
      TRUE ~ "Other"
    )
  )

prescriptions <- prescriptions %>%
  mutate(
    year = year(presc_date)
  )

ggplot(prescriptions %>% filter(!is.na(presc_date), !is.na(drug_form)), aes(x = factor(year), fill = drug_form_std)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Poměr způsobu podání v čase",
    x = "Rok",
    y = "%",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

```{r}
client_yearly_counts <- prescriptions %>%
  filter(!is.na(presc_date), !is.na(drug_form)) %>%
  group_by(client_id, year, drug_form_std) %>%
  summarise(presc_count = n(), .groups = "drop")

average_freq_per_year <- client_yearly_counts %>%
  group_by(year, drug_form_std) %>%
  summarise(avg_presc_per_client = mean(presc_count), .groups = "drop")

ggplot(average_freq_per_year, aes(x = factor(year), y = avg_presc_per_client, fill = drug_form_std)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Počet předpisů za rok na klienta dle způsobu podání",
    x = "Rok",
    y = "Průměrný počet předpisů na klienta",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

Při vykreslení poměru injekcí a infuzí na tablety je zde opět zajímavý nárůst ve prospěch tablet ve druhé polovině roku 2021.

```{r}
filtered_data <- prescriptions %>%
  mutate(
    drug_form_std = ifelse(is.na(drug_form_std), "Unknown", drug_form_std)
  ) %>%
  filter(
    drug_form_std %in% c("Injekce / Infuze", "Tableta"),
    !is.na(vaccinated),
    !is.na(presc_yearmonth)
  )

form_vax_counts <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated, drug_form_std) %>%
  summarise(n = n(), .groups = "drop")

month_totals <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated) %>%
  summarise(total = n(), .groups = "drop")

form_vax_ratios <- form_vax_counts %>%
  left_join(month_totals, by = c("presc_yearmonth", "vaccinated")) %>%
  mutate(ratio = n / total)

form_vax_ratios <- form_vax_ratios %>%
  mutate(group = paste(drug_form_std, ifelse(vaccinated == "Vakcinace", "Vakcinace", "Bez vakcinace"), sep = " - "))

ggplot(form_vax_ratios, aes(x = presc_yearmonth, y = ratio, color = group)) +
  geom_line(size = 0.6) +                   
  geom_smooth(se = FALSE, span = 0.3) +   
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_date(date_labels = "%Y",         
               date_breaks = "1 year",
               expand = c(0.01, 0)) +
  labs(
    title = "Poměr počtu předpisů podle způsobu podání a vakcinace",
    x = "Datum",
    y = "Poměr počtu předpisů",
    color = "Forma podání + Vakcinace"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
```

## Shrnutí

Zatímco prvopředpisovost významně stoupla, tak multipředpisovost zůstává v zásadě na stejné úrovni a v některých případech dokonce i klesá. Rozdíly mezi očkovanými a neočkovanými jedinci jsou zanedbatelné.

Trendy způsobu podání jsou v této skupině oproti mladším populacím ustálené s jediným výkyvem ve druhé polovině roku 2022.

# Krátkodobý efekt 16-39

## Prvopředpisy

### SCCS vakcinovaných

Všeobecně je riziko prvopředpisu po vakcinaci vyšší oproti baseline před očkováním. Z hlediska statistické významnosti lze ale s určitou dávkou jistoty takto zhodnotit pouze období `0-29`, `90-179` a `270-365`. 

```{r, results = 'asis'}
combined_vaccinated_prescribed <- dbGetQuery(con,
                                    "
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    'CPZP' as ins_company
                                    FROM cpzp_vaccinations v
                                    LEFT JOIN cpzp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.presc_order = 1
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-06-15' - INTERVAL '7 days'
                                                       AND DATE '2021-06-15' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    
                                    UNION
                                    
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    'OZP' AS ins_company
                                    FROM OZP_vaccinations v
                                    LEFT JOIN ozp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN ozp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.presc_order = 1
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-06-15' - INTERVAL '7 days'
                                                       AND DATE '2021-06-15' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    ") %>%
  mutate(client_id = row_number()) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_vaccinated <- combined_vaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_vaccinated)), collapse = "\n"), "\n```")
```

### SCCS nevakcinovaných

I v případě neočkovaných jsou rizika po celou dobu relativně vyšší. Díky většímu množství dat je také možné zhodnotit tyto výsledky na vyšší hladině statistické významnosti.

```{r, results = 'asis'}
combined_unvaccinated_prescribed <- dbGetQuery(con,
                                               "
                                    SELECT
                                    p.client_id,
                                    DATE '2021-06-15' AS vaccination_date,
                                    p.date AS event_date,
                                    'CPZP' as ins_company
                                    FROM cpzp_prescriptions p
                                    LEFT JOIN cpzp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-06-15'- INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-06-15' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    AND p.date BETWEEN DATE '2021-06-15' - INTERVAL '1 year' AND DATE '2021-06-15' + INTERVAL '1 year'
                                    AND p.presc_order = 1
                                    AND c.n_vacc = 0
                                    
                                    UNION
                                    
                                    SELECT
                                    p.client_id,
                                    DATE '2021-06-15' AS vaccination_date,
                                    p.date AS event_date,
                                    'OZP' as ins_company
                                    FROM ozp_prescriptions p
                                    LEFT JOIN ozp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-06-15' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-06-15' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    AND p.date BETWEEN DATE '2021-06-15' - INTERVAL '1 year' AND DATE '2021-06-15' + INTERVAL '1 year'
                                    AND p.presc_order = 1
                                    AND c.n_vacc = 0

                                               ") %>%
  mutate(client_id = row_number()) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_unvaccinated <- combined_unvaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_unvaccinated)), collapse = "\n"), "\n```")
```

### Porovnání rizik

Průběh rizik je pro obě skupiny v zásadě srovnatelný s vyšším stanoveným rizikem pro očkovanou populaci. Ani jeden z rozdílů však není statisticky signifikantní.

```{r}
coef_unvax <- sccs_result_unvaccinated$coefficients
conf_unvax <- sccs_result_unvaccinated$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated$coefficients
conf_vax <- sccs_result_vaccinated$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Bez Vakcinace")
df_vax <- df_vax %>% mutate(group = "Vakcinace")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(
  is.infinite(end_days),
  paste0(start_days, "+"),
  paste0(start_days, "-", end_days)
)

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2,
                position = position_dodge(width = 0.6)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Období expozice (dny)",
    y = "Poměr rizik (HR)",
    title = "Porovnání SCCS: očkovaní vs neočkovaní"
  ) +
  theme_minimal()
```

```{r}
vax_df <- combined %>%
  filter(group == "Vakcinace") %>%
  rename_with(~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Bez Vakcinace") %>%
  rename_with(~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.2, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)",
    x = "Období expozice",
    y = "Rozdíl v log(HR)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(did_results, data.frame(
    term = term,
    period_label = period_label,
    logHR_vax = logHR_vax,
    logHR_unvax = logHR_unvax,
    DiD_logHR = DiD_logHR,
    DiD_SE = DiD_SE,
    Z = Z,
    P_value = P_value
  ))
}

did_results %>%
  transmute(Období = period_label, `log(HR) Vakcinace` = logHR_vax, `log(HR) Bez vakcinace` = logHR_unvax, `DiD log(HR)` = DiD_logHR, p_value = P_value) %>%
  kable(format = "html", caption = "Porovnání rizik očkovaných a neočkovaných (SCCS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

## Předpisy celkem

### SCCS vakcinovaných

Vyšší množství dat pro úhrn předpisů celkem umožňuje čistší pohled na zhodnocená rizika. Ta jsou stejně jako u prvopředpisů po celé sledované období vyšší než baseline.

```{r, results = 'asis'}
combined_vaccinated_prescribed <- dbGetQuery(con,
                                    "
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'CPZP' as ins_company
                                    FROM cpzp_vaccinations v
                                    LEFT JOIN cpzp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-06-15' - INTERVAL '7 days'
                                                       AND DATE '2021-06-15' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    
                                    UNION
                                    
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'OZP' AS ins_company
                                    FROM OZP_vaccinations v
                                    LEFT JOIN ozp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN ozp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    LEFT JOIN ozp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-06-15' - INTERVAL '7 days'
                                                       AND DATE '2021-06-15' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         drug_form = tolower(drug_form),
         inj_or_inf = str_detect(drug_form, "injekční|infuzní"))

injectable_infusional <- combined_vaccinated_prescribed %>%
  filter(inj_or_inf) %>%
  arrange(client_id, event_date) %>%
  group_by(client_id) %>%
  mutate(
    day_diff = as.numeric(difftime(event_date, lag(event_date, default = first(event_date)), units = "days")),
    new_window = is.na(day_diff) | day_diff > 10,
    window_id = cumsum(new_window)
  ) %>%
  group_by(client_id, window_id) %>%
  slice(1) %>%
  ungroup()

other_drugs <- combined_vaccinated_prescribed %>%
  filter(!inj_or_inf)

combined_vaccinated_prescribed <- bind_rows(injectable_infusional, other_drugs) %>%
  arrange(client_id, event_date) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_vaccinated <- combined_vaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_vaccinated)), collapse = "\n"), "\n```")
```

### SCCS nevakcinovaných

Je patrné že průběh rizik pro neočkované téměř kopíruje průběh rizik očkovaných jedinců.

```{r, results = 'asis'}
combined_unvaccinated_prescribed <- dbGetQuery(con,
                                               "
                                    SELECT
                                    p.client_id,
                                    DATE '2021-06-15' AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'CPZP' as ins_company
                                    FROM cpzp_prescriptions p
                                    LEFT JOIN cpzp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-06-15' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-06-15' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    AND p.date BETWEEN DATE '2021-06-15' - INTERVAL '1 year' AND DATE '2021-06-15' + INTERVAL '1 year'
                                    AND c.n_vacc = 0
                                    
                                    UNION
                                    
                                    SELECT
                                    p.client_id,
                                    DATE '2021-06-15' AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'OZP' as ins_company
                                    FROM ozp_prescriptions p
                                    LEFT JOIN ozp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    LEFT JOIN ozp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-06-15' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-06-15' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 16 AND 39
                                    AND p.date BETWEEN DATE '2021-06-15' - INTERVAL '1 year' AND DATE '2021-06-15' + INTERVAL '1 year'
                                    AND c.n_vacc = 0

                                               ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         drug_form = tolower(drug_form),
         inj_or_inf = str_detect(drug_form, "injekční|infuzní"))

injectable_infusional <- combined_unvaccinated_prescribed %>%
  filter(inj_or_inf) %>%
  arrange(client_id, event_date) %>%
  group_by(client_id) %>%
  mutate(
    day_diff = as.numeric(difftime(event_date, lag(event_date, default = first(event_date)), units = "days")),
    new_window = is.na(day_diff) | day_diff > 10,
    window_id = cumsum(new_window)
  ) %>%
  group_by(client_id, window_id) %>%
  slice(1) %>%
  ungroup()

other_drugs <- combined_unvaccinated_prescribed %>%
  filter(!inj_or_inf)

combined_unvaccinated_prescribed <- bind_rows(injectable_infusional, other_drugs) %>%
  arrange(client_id, event_date) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_unvaccinated <- combined_unvaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_unvaccinated)), collapse = "\n"), "\n```")
```

### Porovnání rizik

Porovnatelnost mezi skupinami je téměř nulová. Jediný rozdíl je v období `270-365`, kde je vyšší riziko pro očkované s p-hodnotou Waldova testu těsně nad úrovní 0,08.

```{r}
coef_unvax <- sccs_result_unvaccinated$coefficients
conf_unvax <- sccs_result_unvaccinated$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated$coefficients
conf_vax <- sccs_result_vaccinated$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Unvaccinated")
df_vax <- df_vax %>% mutate(group = "Vaccinated")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(
  is.infinite(end_days),
  paste0(start_days, "+"),
  paste0(start_days, "-", end_days)
)

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2,
                position = position_dodge(width = 0.6)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Období expozice (dny)",
    y = "Poměr rizik (HR)",
    title = "Porovnání SCCS: očkovaní vs neočkovaní"
  ) +
  theme_minimal()
```

```{r}
vax_df <- combined %>%
  filter(group == "Vaccinated") %>%
  rename_with(~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Unvaccinated") %>%
  rename_with(~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.2, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)",
    x = "Období expozice",
    y = "Rozdíl v log(HR)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(did_results, data.frame(
    term = term,
    period_label = period_label,
    logHR_vax = logHR_vax,
    logHR_unvax = logHR_unvax,
    DiD_logHR = DiD_logHR,
    DiD_SE = DiD_SE,
    Z = Z,
    P_value = P_value
  ))
}

did_results %>%
  transmute(Období = period_label, `log(HR) Vakcinace` = logHR_vax, `log(HR) Bez vakcinace` = logHR_unvax, `DiD log(HR)` = DiD_logHR, p_value = P_value) %>%
  kable(format = "html", caption = "Porovnání rizik (SCCS) očkovaných a neočkovaných") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

## Shrnutí

Krátkodobá rizika jsou ve všech případech vyšší oproti baseline a v zásadě srovnatelná. Jediný částečně významný rozdíl je u celkového úhrnu předpisů v období `270-365` s vyšším rizikem pro očkované.

# Věková kategorie 40-59

## Dlouhodobý efekt

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
prescriptions <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.force AS strength,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN cpzp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 40 AND 59
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            p.date AS presc_date,
                            v.date AS vacc_date,
                            d.drug_form,
                            d.ATC_group,
                            d.Prednison_equiv AS prednison_equiv,
                            d.strength,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          LEFT JOIN ozp_vaccinations v ON c.client_id = v.client_id AND event_order = 1
                          LEFT JOIN ozp_drugs_catalog d ON p.presc_id = d.presc_id 
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 40 AND 59
                          ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         vacc_yearmonth = floor_date(vacc_date, unit = "month"),
         presc_yearmonth = floor_date(presc_date, unit = "month"),
         vaccinated = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         sex = ifelse(sex == "Z", "F", sex),
         first_presc_flag = ifelse(!is.na(presc_date) & first_presc_date == presc_date,1,0))
```

### Distribuce věku a pohlaví

```{r}
unique_clients <- prescriptions %>%
  filter(!is.na(age_2021), !is.na(sex), !is.na(vaccinated)) %>%
  distinct(client_id, .keep_all = TRUE)  

age_data <- unique_clients %>%
  group_by(vaccinated, age_2021) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Age",
         value = as.character(age_2021)) %>%
  ungroup()

sex_data <- unique_clients %>%
  group_by(vaccinated, sex) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(vaccinated) %>%
  mutate(prop = count / sum(count),
         variable = "Sex",
         value = sex) %>%
  ungroup()
```

Stáří populace a poměr dle pohlaví jsou v zásadě srovnatelné.

```{r}
ggplot(unique_clients, aes(x = age_2021, fill = factor(vaccinated))) +
  geom_histogram(aes(y = after_stat(density)), position = "identity", alpha = 0.4, binwidth = 1) +
  scale_fill_brewer(palette = "Set1", name = "Vaccinated") +
  scale_x_continuous(breaks = seq(floor(min(unique_clients$age)), ceiling(max(unique_clients$age)), by = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Věkové rozložení podle statusu vakcinace",
    x = "Věk", y = "%",
    fill = "Vakcinace"
  ) +
  theme_minimal()
```

```{r}
ggplot(sex_data, aes(x = sex, y = prop, color = vaccinated, group = vaccinated)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Pohlaví podle vakcinace",
    x = "Pohlaví",
    y = "%",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

### Předpověď vs realita

```{r}
prescriptions_clean <- prescriptions %>%
  filter(!is.na(presc_date)) %>%
  mutate(presc_date = as.Date(presc_date)) %>%
  arrange(presc_date) %>%
  filter(presc_date >= as.Date("2015-01-01") & presc_date <= as.Date("2023-12-31")) %>%
  mutate(count = 1)  


results_vacc <- prescriptions_clean %>%
  filter(!is.na(vaccinated)) %>%
  group_by(vaccinated) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$vaccinated)
    analyze_group(df = filter(prescriptions_clean, vaccinated == group_val), 
                  group_id = group_val, 
                  group_type = "Vaccination")
  }) %>%
  compact() %>%
  bind_rows()

results_sex <- prescriptions_clean %>%
  filter(!is.na(sex)) %>%
  group_by(sex) %>%
  group_split() %>%
  map(~ {
    group_val <- unique(.x$sex)
    analyze_group(df = filter(prescriptions_clean, sex == group_val), 
                  group_id = group_val, 
                  group_type = "Sex")
  }) %>%
  compact() %>%
  bind_rows()

results_all <- bind_rows(results_vacc, results_sex) %>%
  arrange(p_value)

plot_data_all <- results_all %>%
  unnest(plot_data, names_sep = "_")
```

ETS model vykazuje odchylky napříč všemi skupinami s nejvýraznějším rozdílem u neočkované populace.

```{r, results = 'asis'}
results_all %>%
  mutate(Skupina = group, RMSE = rmse, rRMSE = rrmse) %>%
  select(
    Skupina, RMSE, rRMSE, t_stat, p_value
  ) %>%
  kable(format = "html", caption = "Porovnání předpisovosti v čase (ETS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(plot_data_all, aes(x = plot_data_month)) +
  geom_line(aes(y = plot_data_prescriptions), color = "blue") +
  geom_line(aes(y = plot_data_predicted), color = "red", linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-01-01"), linetype = "dotted") +
  facet_wrap(~ paste(plot_data_group_type, plot_data_group, sep = ": "), scales = "free_y") +
  labs(
    title = "Realita vs Předpověď (ETS)",
    subtitle = "Modrá = Realita, Červená = Předpověď",
    x = "Datum", y = "Počet předpisů"
  ) +
  theme_minimal()

```

### Prvopředpisovost

```{r}
first_presc <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'CPZP' AS ins_company
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 40 AND 59
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.date ASC) AS first_presc_date,
                            'OZP' AS ins_company
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id AND p.presc_order = 1
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 40 AND 59
                          ") %>%
  mutate(first_presc_yearmonth = floor_date(first_presc_date, unit = "month"),
         sex = ifelse(sex == "Z", "F", sex),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"),
         age_2021 = 2021 - birthyear)

monthly_first_presc <- first_presc %>%
  count(first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(first_presc_yearmonth) %>%
  mutate(
    cum_new_presc = cumsum(new_prescriptions),  
    total_population = nrow(first_presc),
    at_risk_population = total_population - lag(cum_new_presc, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )

monthly_clean <- monthly_first_presc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

ttest <- t.test(rate ~ period_group, data = monthly_clean)
```

Průměrná prvopředpisovost ve srovnání po vs před je mírně nižší. Samotný rozdíl průměrů však není statisticky významný.

```{r}
ggplot(monthly_first_presc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000)) +
  geom_line(color = "steelblue", size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Počet prvopředpisů na 1000 osob bez předpisu", limits = c(0, 10)) +
  labs(
    title = "Prvopředpisovost v čase",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
cat("```\n", paste(capture.output(ttest), collapse = "\n"), "\n```")
```

```{r}
total_by_vacc <- first_presc %>%
  count(vacc_status, name = "total_population")

monthly_by_vacc <- first_presc %>%
  count(vacc_status, first_presc_yearmonth, name = "new_prescriptions") %>%
  arrange(vacc_status, first_presc_yearmonth) %>%
  group_by(vacc_status) %>%
  mutate(
    cum_prescriptions = cumsum(new_prescriptions),
    total_population = total_by_vacc$total_population[match(vacc_status, total_by_vacc$vacc_status)],
    at_risk_population = total_population - lag(cum_prescriptions, default = 0),
    rate = new_prescriptions / at_risk_population
  ) %>%
  ungroup() %>%
  mutate(
    period_group = case_when(
      first_presc_yearmonth < as.Date("2020-01-01") ~ "Pre-COVID",
      first_presc_yearmonth > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )
  
monthly_by_vacc_clean <- monthly_by_vacc %>%
  filter(first_presc_yearmonth >= as.Date("2018-01-01")) %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))

first_presc_table <- monthly_by_vacc_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(rate ~ period_group)$p.value,
    mean_before = mean(rate[period_group == "Pre-COVID"]),
    mean_after = mean(rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```

Obě skupiny vykazují mírné snížení v prvopředpisovosti. Rozdíl mezi skupinami je nevýznamný.

```{r, results = 'asis'}
first_presc_table %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before * 1000, `Průměr po` = mean_after * 1000, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání prvopředpisovosti v čase podle vakcinace") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

```{r}
ggplot(monthly_by_vacc %>% filter(first_presc_yearmonth >= as.Date("2018-01-01")),
       aes(x = first_presc_yearmonth, y = rate * 1000, color = vacc_status)) +
  geom_line(size = 1) +
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Počet předpisů na 1000 osob bez předpisu", limits = c(0, 10)) +
  labs(
    title = "Prvopředpisovost v čase podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
monthly_rates <- monthly_by_vacc %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID")) %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(first_presc_yearmonth >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid)

did_model <- lm(log(rate * 1000) ~ vaccinated * post_covid, data = monthly_rates)

cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Multipředpisovost

#### Míra retence (meziroční multipředpisovost)

```{r}
presc_id_counts <- dbGetQuery(con,
                          "
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'CPZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            cpzp_clients c
                          LEFT JOIN cpzp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date = '9999-12-31'
                            AND 2021 - c.birthyear BETWEEN 40 AND 59
                            
                          UNION
                          
                          SELECT
                            c.client_id,
                            c.n_vacc,
                            c.n_presc,
                            c.sex,
                            c.birthyear,
                            2021 - c.birthyear AS age_2021,
                            p.date as presc_date,
                            p.presc_order,
                            'OZP' AS ins_company,
                            YEAR(FIRST(p.date) OVER (PARTITION BY c.client_id ORDER BY p.presc_order ASC)) AS first_presc_year
                          FROM
                            ozp_clients c
                          LEFT JOIN ozp_ins_start_end i ON c.client_id = i.client_id
                          LEFT JOIN ozp_prescriptions p ON c.client_id = p.client_id
                          WHERE
                            i.ins_start_date < '2015-01-01' AND i.ins_end_date IS NULL
                            AND 2021 - c.birthyear BETWEEN 40 AND 59
                          ")%>%
  mutate(presc_year = as.integer(format(as.Date(presc_date), "%Y")),
         vacc_status = ifelse(n_vacc > 0, "Vakcinace", "Bez vakcinace"))

monthly_unique_clients <- presc_id_counts %>%
  mutate(yearmonth = floor_date(presc_date, unit = "month")) %>%
  distinct(client_id, yearmonth, vacc_status) %>%
  count(yearmonth, vacc_status, name = "n_unique_clients")

presc_years <- presc_id_counts %>%
  mutate(
    presc_year = year(presc_date)
  ) %>%
  distinct(client_id, first_presc_year, presc_year, vacc_status) %>%
  filter(first_presc_year >= 2017, first_presc_year <= 2023)


retention_data <- presc_years %>%
  mutate(year_offset = presc_year - first_presc_year) %>%
  filter(year_offset >= 0)


retention_summary <- retention_data %>%
  group_by(first_presc_year, year_offset, vacc_status) %>%
  summarise(n_clients = n_distinct(client_id), .groups = "drop")


cohort_sizes <- retention_data %>%
  filter(year_offset == 0) %>%
  group_by(first_presc_year, vacc_status) %>%
  summarise(cohort_size = n_distinct(client_id), .groups = "drop")


retention_summary <- retention_summary %>%
  left_join(cohort_sizes, by = c("first_presc_year", "vacc_status")) %>%
  mutate(retention_rate = n_clients / cohort_size)

retention_summary_filtered <- retention_summary %>%
  filter(year_offset > 0)
```

Míra meziročních předpisů stále potvrzuje trend z předchozích sledování. Je vyšší než u mladší populace a míra pro očkované je všeobecně vyšší.

```{r}
ggplot(retention_summary_filtered, aes(x = year_offset, y = retention_rate, color = as.factor(first_presc_year))) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_color_viridis_d(name = "Rok prvopředpisu") +
  labs(
    title = "Retence (meziroční předpisovost) podle vakcinace",
    x = "Počet let od prvopředpisu",
    y = "Míra multipředpisovosti"
  ) +
  facet_wrap(~ vacc_status) +
  theme_minimal(base_size = 13)
```

#### Roční multipředpisovost

```{r, echo=FALSE}
multi_presc <- dbGetQuery(con,
                          "
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          ozp_prescriptions p
                          INNER JOIN ozp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 40 AND 59
                          INNER JOIN ozp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date IS NULL

                          
                          UNION
                          
                          SELECT
                          p.client_id,
                          p.date,
                          p.presc_order,
                          IF(c.n_vacc > 0, 'Vakcinace', 'Bez vakcinace') AS vacc_status
                          FROM
                          cpzp_prescriptions p
                          INNER JOIN cpzp_clients c ON p.client_id = c.client_id AND 2021 - c.birthyear BETWEEN 40 AND 59
                          INNER JOIN cpzp_ins_start_end i ON p.client_id = i.client_id
                                                         AND i.ins_start_date < '2015-01-01'
                                                         AND i.ins_end_date = '9999-12-31'
                          ")
```

```{r}
multi_presc_yearly <- multi_presc %>%
  mutate(year = year(date)) %>%
  filter(year > 2017)


multi_clients_yearly <- multi_presc_yearly %>%
  group_by(year, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_yearly <- multi_clients_yearly %>%
  group_by(year, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_yearly <- multi_summary_yearly %>%
  mutate(
    period_group = case_when(
      year < 2020 ~ "Pre-COVID",
      year > 2021 ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_yearly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before,
    .groups = "drop"
  )
```

Roční multipředpisovost stoupá v obou kategoriích. Míra změny mezi skupinami je nevýznamná.

```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání roční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```

```{r}
ggplot(multi_summary_yearly, aes(x = year, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.6, alpha = 0.4) +
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +
  annotate("rect",
           xmin = 2020, xmax = 2021,
           ymin = -Inf, ymax = Inf,
           alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Roční multipředpisovost na 1000 předepsaných klientů") +
  scale_x_continuous(breaks = unique(multi_summary_yearly$year)) +
  labs(
    title = "Roční multipředpisovost podle vakcinace",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Rok",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year >= 2022, 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

#### Měsíční multipředpisovost

Míra měsíční multipředpisovosti vykazuje zajímavé rozdělení trendů opačnými směry v období covidu, kdy všeobecné riziko bylo u vakcinovaných jedinců menší. Tento rozdíl je statisticky významný.

```{r, echo=FALSE}
multi_presc <- multi_presc %>%
  mutate(year_month = floor_date(date, unit = "month"))

multi_clients_by_month <- multi_presc %>%
  group_by(year_month, vacc_status, client_id) %>%
  summarise(presc_count = n(), .groups = "drop") %>%
  mutate(is_multi = presc_count > 1)


multi_summary_monthly <- multi_clients_by_month %>%
  filter(year_month > "2017-12-31") %>%
  group_by(year_month, vacc_status) %>%
  summarise(
    total_clients = n(),
    multi_clients = sum(is_multi),
    multi_rate = (multi_clients / total_clients) * 1000,
    .groups = "drop"
  )


multi_summary_monthly <- multi_summary_monthly %>%
  mutate(
    period_group = case_when(
      year_month < as.Date("2020-01-01") ~ "Pre-COVID",
      year_month > as.Date("2021-12-31") ~ "Post-COVID",
      TRUE ~ "COVID-Shock"
    )
  )


multi_summary_clean <- multi_summary_monthly %>%
  filter(period_group %in% c("Pre-COVID", "Post-COVID"))


t_test_results <- multi_summary_clean %>%
  group_by(vacc_status) %>%
  summarise(
    p_value = t.test(multi_rate ~ period_group)$p.value,
    mean_before = mean(multi_rate[period_group == "Pre-COVID"]),
    mean_after = mean(multi_rate[period_group == "Post-COVID"]),
    rate = mean_after / mean_before
  )
```


```{r, results = 'asis'}
t_test_results %>%
  transmute(Vakcinace = vacc_status, p_value, `Průměr před` = mean_before, `Průměr po` = mean_after, `Poměr` = rate) %>%
  kable(format = "html", caption = "Porovnání měsíční multipředpisovosti v čase") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )

```


```{r}
ggplot(multi_summary_monthly, aes(x = year_month, y = multi_rate, color = vacc_status)) +
  geom_line(size = 0.5, alpha = 0.4) + 
  stat_smooth(method = "loess", se = FALSE, size = 1.2) +  
  annotate("rect",
           xmin = as.Date("2020-01-01"), xmax = as.Date("2021-12-31"),
           ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "gray50") +
  scale_y_continuous(name = "Měsíční multipředpisovost na 1000 předepsaných klientů") +
  labs(
    title = "Měsíční multipředpisovost podle vakcinačního statusu",
    subtitle = "Šedá = covidové období (vyřazeno z t-testu)",
    x = "Datum",
    color = "Vakcinace"
  ) +
  theme_minimal()
```

```{r, results = 'asis'}
did_data <- multi_summary_clean %>%
  mutate(
    vaccinated = if_else(vacc_status == "Vakcinace", 1, 0),
    post_covid = if_else(year_month >= as.Date("2022-01-01"), 1, 0),
    interaction = vaccinated * post_covid
  )

did_model <- lm(log(multi_rate) ~ vaccinated * post_covid, data = did_data)
cat("```\n", paste(capture.output(summary(did_model)), collapse = "\n"), "\n```")
```

### Způsob podání

Trendy nastavené v předchozích kohortách jsou v zásadě nezměněné i ve starší populaci.

```{r}
prescriptions <- prescriptions %>%
  mutate(
    drug_form_std = case_when(
      is.na(drug_form) ~ NA_character_,
      str_detect(drug_form, "tableta|Tableta") ~ "Tableta",
      str_detect(drug_form, "tobolka|Tobolka") ~ "Tobolka",
      str_detect(drug_form, "injekční|Injekční|infuzní|Infuzní") ~ "Injekce / Infuze",
      str_detect(drug_form, "č[íi]pek|Čípek") ~ "Čípek",
      str_detect(drug_form, "perorální roztok|Perorální roztok") ~ "Perorální roztok",
      TRUE ~ "Other"
    )
  )

prescriptions <- prescriptions %>%
  mutate(
    year = year(presc_date)
  )

ggplot(prescriptions %>% filter(!is.na(presc_date), !is.na(drug_form)), aes(x = factor(year), fill = drug_form_std)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Poměr způsobu podání v čase",
    x = "Rok",
    y = "%",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

```{r}
client_yearly_counts <- prescriptions %>%
  filter(!is.na(presc_date), !is.na(drug_form)) %>%
  group_by(client_id, year, drug_form_std) %>%
  summarise(presc_count = n(), .groups = "drop")

average_freq_per_year <- client_yearly_counts %>%
  group_by(year, drug_form_std) %>%
  summarise(avg_presc_per_client = mean(presc_count), .groups = "drop")

ggplot(average_freq_per_year, aes(x = factor(year), y = avg_presc_per_client, fill = drug_form_std)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Počet předpisů za rok na klienta dle způsobu podání",
    x = "Rok",
    y = "Průměrný počet předpisů na klienta",
    fill = "Způsob podání"
  ) +
  theme_minimal()
```

Výkyv v poměru předpisů ve druhé polovině roku 2022 je v případě této kohorty nejvyšší.

```{r}
filtered_data <- prescriptions %>%
  mutate(
    drug_form_std = ifelse(is.na(drug_form_std), "Unknown", drug_form_std)
  ) %>%
  filter(
    drug_form_std %in% c("Injekce / Infuze", "Tableta"),
    !is.na(vaccinated),
    !is.na(presc_yearmonth)
  )

form_vax_counts <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated, drug_form_std) %>%
  summarise(n = n(), .groups = "drop")

month_totals <- filtered_data %>%
  group_by(presc_yearmonth, vaccinated) %>%
  summarise(total = n(), .groups = "drop")

form_vax_ratios <- form_vax_counts %>%
  left_join(month_totals, by = c("presc_yearmonth", "vaccinated")) %>%
  mutate(ratio = n / total)

form_vax_ratios <- form_vax_ratios %>%
  mutate(group = paste(drug_form_std, ifelse(vaccinated == "Vakcinace", "Vakcinace", "Bez vakcinace"), sep = " - "))

ggplot(form_vax_ratios, aes(x = presc_yearmonth, y = ratio, color = group)) +
  geom_line(size = 0.6) +                   
  geom_smooth(se = FALSE, span = 0.3) +   
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_date(date_labels = "%Y",         
               date_breaks = "1 year",
               expand = c(0.01, 0)) +
  labs(
    title = "Poměr počtu předpisů podle způsobu podání a vakcinace",
    x = "Datum",
    y = "Poměr počtu předpisů",
    color = "Forma podání + Vakcinace"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
```

## Krátkodobý efekt

### Prvopředpisy

##### SCCS vakcinovaných

Riziko prvopředpisů u očkovaných je v zásadě nižší oproti baseline. Statisticky významné výsledky jsou však jen v časovém období `30-89` a `180-269`.
```{r, results = 'asis'}
combined_vaccinated_prescribed <- dbGetQuery(con,
                                    "
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    'CPZP' as ins_company
                                    FROM cpzp_vaccinations v
                                    LEFT JOIN cpzp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.presc_order = 1
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-05-21' - INTERVAL '7 days'
                                                       AND DATE '2021-05-21' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    
                                    UNION
                                    
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    'OZP' AS ins_company
                                    FROM OZP_vaccinations v
                                    LEFT JOIN ozp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN ozp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.presc_order = 1
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-05-21' - INTERVAL '7 days'
                                                       AND DATE '2021-05-21' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    ") %>%
  mutate(client_id = row_number()) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_vaccinated <- combined_vaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_vaccinated)), collapse = "\n"), "\n```")
```

##### SCCS nevakcinovaných

Zde je zajímavá změna trendu, kdy riziko neočkovaných v období `180-269` mírně přesáhne baseline.

```{r, results = 'asis'}
combined_unvaccinated_prescribed <- dbGetQuery(con,
                                               "
                                    SELECT
                                    p.client_id,
                                    DATE '2021-05-21' AS vaccination_date,
                                    p.date AS event_date,
                                    'CPZP' as ins_company
                                    FROM cpzp_prescriptions p
                                    LEFT JOIN cpzp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-05-21'- INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-05-21' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    AND p.date BETWEEN DATE '2021-05-21' - INTERVAL '1 year' AND DATE '2021-05-21' + INTERVAL '1 year'
                                    AND p.presc_order = 1
                                    AND c.n_vacc = 0
                                    
                                    UNION
                                    
                                    SELECT
                                    p.client_id,
                                    DATE '2021-05-21' AS vaccination_date,
                                    p.date AS event_date,
                                    'OZP' as ins_company
                                    FROM ozp_prescriptions p
                                    LEFT JOIN ozp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-05-21' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-05-21' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    AND p.date BETWEEN DATE '2021-05-21' - INTERVAL '1 year' AND DATE '2021-05-21' + INTERVAL '1 year'
                                    AND p.presc_order = 1
                                    AND c.n_vacc = 0

                                               ") %>%
  mutate(client_id = row_number()) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_unvaccinated <- combined_unvaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_unvaccinated)), collapse = "\n"), "\n```")
```

#### Porovnání rizik

Při porovnání rizik je všeobecně méně riziková skupina ta očkovaná (která ani v jednom případě nepřesáhne úroveň zvýšeného rizika oproti baseline). Statisticky významné rozdíly jsou v období `30-89` a `180-269`, kdy jsou rizika očkovaných významně menší.

```{r}
coef_unvax <- sccs_result_unvaccinated$coefficients
conf_unvax <- sccs_result_unvaccinated$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated$coefficients
conf_vax <- sccs_result_vaccinated$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Bez Vakcinace")
df_vax <- df_vax %>% mutate(group = "Vakcinace")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(
  is.infinite(end_days),
  paste0(start_days, "+"),
  paste0(start_days, "-", end_days)
)

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2,
                position = position_dodge(width = 0.6)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Období expozice (dny)",
    y = "Poměr rizik (HR)",
    title = "Porovnání SCCS: očkovaní vs neočkovaní"
  ) +
  theme_minimal()
```

```{r}
vax_df <- combined %>%
  filter(group == "Vakcinace") %>%
  rename_with(~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Bez Vakcinace") %>%
  rename_with(~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.2, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)",
    x = "Období expozice",
    y = "Rozdíl v log(HR)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(did_results, data.frame(
    term = term,
    period_label = period_label,
    logHR_vax = logHR_vax,
    logHR_unvax = logHR_unvax,
    DiD_logHR = DiD_logHR,
    DiD_SE = DiD_SE,
    Z = Z,
    P_value = P_value
  ))
}

did_results %>%
  transmute(Období = period_label, `log(HR) Vakcinace` = logHR_vax, `log(HR) Bez vakcinace` = logHR_unvax, `DiD log(HR)` = DiD_logHR, p_value = P_value) %>%
  kable(format = "html", caption = "Porovnání rizik očkovaných a neočkovaných (SCCS)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

### Předpisy celkem

#### SCCS vakcinovaných

Díky opravdu velkému množství dat jsou veškeré výsledky statisticky významné. Riziko jako takové kolísá nejprve snížením pod úroveň baseline a poté postupným navyšováním s vrcholem na konci sledovaného období.

```{r, results = 'asis'}
combined_vaccinated_prescribed <- dbGetQuery(con,
                                    "
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'CPZP' as ins_company
                                    FROM cpzp_vaccinations v
                                    LEFT JOIN cpzp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN cpzp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-05-21' - INTERVAL '7 days'
                                                       AND DATE '2021-05-21' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    
                                    UNION
                                    
                                    SELECT
                                    v.client_id,
                                    v.date AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'OZP' AS ins_company
                                    FROM OZP_vaccinations v
                                    LEFT JOIN ozp_clients c ON v.client_id = c.client_id
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    INNER JOIN ozp_prescriptions p ON c.client_id = p.client_id
                                                                    AND p.date BETWEEN v.date - INTERVAL '1 year' AND v.date + INTERVAL '1 year'
                                    LEFT JOIN ozp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE v.event_order = 1
                                    AND s.ins_start_date < v.date - INTERVAL '1 year'
                                    AND s.ins_end_date > v.date + INTERVAL '1 year'
                                    AND v.date BETWEEN DATE '2021-05-21' - INTERVAL '7 days'
                                                       AND DATE '2021-05-21' + INTERVAL '7 days'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         drug_form = tolower(drug_form),
         inj_or_inf = str_detect(drug_form, "injekční|infuzní"))

injectable_infusional <- combined_vaccinated_prescribed %>%
  filter(inj_or_inf) %>%
  arrange(client_id, event_date) %>%
  group_by(client_id) %>%
  mutate(
    day_diff = as.numeric(difftime(event_date, lag(event_date, default = first(event_date)), units = "days")),
    new_window = is.na(day_diff) | day_diff > 10,
    window_id = cumsum(new_window)
  ) %>%
  group_by(client_id, window_id) %>%
  slice(1) %>%
  ungroup()

other_drugs <- combined_vaccinated_prescribed %>%
  filter(!inj_or_inf)

combined_vaccinated_prescribed <- bind_rows(injectable_infusional, other_drugs) %>%
  arrange(client_id, event_date) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_vaccinated <- combined_vaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_vaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_vaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_vaccinated)), collapse = "\n"), "\n```")
```

#### SCCS nevakcinovaných

Trend neočkovaných v zásadě kopíruje trend vakcinované skupiny a to i v ohledu významnosti výsledků.

```{r, results = 'asis'}
combined_unvaccinated_prescribed <- dbGetQuery(con,
                                               "
                                    SELECT
                                    p.client_id,
                                    DATE '2021-05-21' AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'CPZP' as ins_company
                                    FROM cpzp_prescriptions p
                                    LEFT JOIN cpzp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN cpzp_ins_start_end s ON c.client_id = s.client_id
                                    LEFT JOIN cpzp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-05-21' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-05-21' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    AND p.date BETWEEN DATE '2021-05-21' - INTERVAL '1 year' AND DATE '2021-05-21' + INTERVAL '1 year'
                                    AND c.n_vacc = 0
                                    
                                    UNION
                                    
                                    SELECT
                                    p.client_id,
                                    DATE '2021-05-21' AS vaccination_date,
                                    p.date AS event_date,
                                    d.drug_form,
                                    'OZP' as ins_company
                                    FROM ozp_prescriptions p
                                    LEFT JOIN ozp_clients c ON P.client_id = c.client_id 
                                    LEFT JOIN ozp_ins_start_end s ON c.client_id = s.client_id
                                    LEFT JOIN ozp_drugs_catalog d ON p.presc_id  = d.presc_id 
                                    WHERE 1 = 1
                                    AND s.ins_start_date < DATE '2021-05-21' - INTERVAL '1 year'
                                    AND s.ins_end_date > DATE '2021-05-21' + INTERVAL '1 year'
                                    AND 2021 - c.birthyear BETWEEN 40 AND 59
                                    AND p.date BETWEEN DATE '2021-05-21' - INTERVAL '1 year' AND DATE '2021-05-21' + INTERVAL '1 year'
                                    AND c.n_vacc = 0

                                               ") %>%
  mutate(client_id = as.numeric(factor(client_id)),
         drug_form = tolower(drug_form),
         inj_or_inf = str_detect(drug_form, "injekční|infuzní"))

injectable_infusional <- combined_unvaccinated_prescribed %>%
  filter(inj_or_inf) %>%
  arrange(client_id, event_date) %>%
  group_by(client_id) %>%
  mutate(
    day_diff = as.numeric(difftime(event_date, lag(event_date, default = first(event_date)), units = "days")),
    new_window = is.na(day_diff) | day_diff > 10,
    window_id = cumsum(new_window)
  ) %>%
  group_by(client_id, window_id) %>%
  slice(1) %>%
  ungroup()

other_drugs <- combined_unvaccinated_prescribed %>%
  filter(!inj_or_inf)

combined_unvaccinated_prescribed <- bind_rows(injectable_infusional, other_drugs) %>%
  arrange(client_id, event_date) %>%
  transmute(
    person_id = client_id,
    exposure_start_date = vaccination_date,
    event_date,
    observation_start_date = vaccination_date - days(365),
    observation_end_date = vaccination_date + days(365)
  )

sccs_unvaccinated <- combined_unvaccinated_prescribed %>%
  mutate(
    event_day = as.integer(event_date - observation_start_date),
    exposure_start_day = as.integer(exposure_start_date - observation_start_date),
    observation_start_day = 0,
    observation_end_day = as.integer(observation_end_date - observation_start_date)
  )

sccs_result_unvaccinated <- standardsccs(
  formula = event_day ~ exposure_start_day,
  indiv = person_id,
  astart = observation_start_day,
  aend = observation_end_day,
  aevent = event_day,
  adrug = exposure_start_day,
  aedrug = exposure_start_day + 365,
  expogrp = list(c(0, 30, 90, 180, 270)),
  data = sccs_unvaccinated
)

cat("```\n", paste(capture.output(print(sccs_result_unvaccinated)), collapse = "\n"), "\n```")
```

#### Porovnání rizik

Vzhledem k tomu, že trendy jsou v zásadě srovnatelné, není možné po většinu sledovaného období jednoznačně vyvodit vyšší riziko pro jednu nebo druhou skupinu. Jediný rozdíl je v období `30-89`, kdy je riziko významně nižší pro očkovanou populaci.

```{r}
coef_unvax <- sccs_result_unvaccinated$coefficients
conf_unvax <- sccs_result_unvaccinated$conf.int

df_unvax <- data.frame(
  term = rownames(coef_unvax),
  logHR = coef_unvax[, "coef"],
  SE = coef_unvax[, "se(coef)"],
  HR = coef_unvax[, "exp(coef)"],
  conf.low = conf_unvax[, "lower .95"],
  conf.high = conf_unvax[, "upper .95"]
)

coef_vax <- sccs_result_vaccinated$coefficients
conf_vax <- sccs_result_vaccinated$conf.int

df_vax <- data.frame(
  term = rownames(coef_vax),
  logHR = coef_vax[, "coef"],
  SE = coef_vax[, "se(coef)"],
  HR = coef_vax[, "exp(coef)"],
  conf.low = conf_vax[, "lower .95"],
  conf.high = conf_vax[, "upper .95"]
)

df_unvax <- df_unvax %>% mutate(group = "Unvaccinated")
df_vax <- df_vax %>% mutate(group = "Vaccinated")

combined <- bind_rows(df_vax, df_unvax)

combined$period <- as.integer(gsub("exposure_start_day", "", combined$term))

start_days <- c(0, 30, 90, 180, 270)
end_days   <- c(29, 89, 179, 269, Inf)

period_labels <- ifelse(
  is.infinite(end_days),
  paste0(start_days, "+"),
  paste0(start_days, "-", end_days)
)

combined$period_label <- factor(combined$period,
                                levels = seq_along(period_labels),
                                labels = period_labels)

ggplot(combined, aes(x = period_label, y = HR, color = group)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2,
                position = position_dodge(width = 0.6)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Období expozice (dny)",
    y = "Poměr rizik (HR)",
    title = "Porovnání SCCS: očkovaní vs neočkovaní"
  ) +
  theme_minimal()
```

```{r}
vax_df <- combined %>%
  filter(group == "Vaccinated") %>%
  rename_with(~ paste0(., "_vax"), -c(period, period_label))

unvax_df <- combined %>%
  filter(group == "Unvaccinated") %>%
  rename_with(~ paste0(., "_unvax"), -c(period, period_label))

df_diff <- inner_join(vax_df, unvax_df, by = c("period", "period_label"))

df_diff <- df_diff %>%
  mutate(
    logHR_diff = logHR_vax - logHR_unvax,
    se_diff = sqrt(SE_vax^2 + SE_unvax^2),
    ci_low = logHR_diff - 1.96 * se_diff,
    ci_high = logHR_diff + 1.96 * se_diff
  )

ggplot(df_diff, aes(x = period_label, y = logHR_diff)) +
  geom_point(color = "blue", size = 3) +
  geom_errorbar(aes(ymin = ci_low, ymax = ci_high), width = 0.2, color = "blue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Rozdíl v log(HR) (Očkovaní - Neočkovaní)",
    x = "Období expozice",
    y = "Rozdíl v log(HR)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results = 'asis'}
common_terms <- intersect(df_vax$term, df_unvax$term)

did_results <- data.frame(
  term = character(),
  period_label = character(),
  logHR_vax = numeric(),
  logHR_unvax = numeric(),
  DiD_logHR = numeric(),
  DiD_SE = numeric(),
  Z = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

for (term in common_terms) {
  logHR_vax <- df_vax %>% filter(term == !!term) %>% pull(logHR)
  SE_vax    <- df_vax %>% filter(term == !!term) %>% pull(SE)
  
  logHR_unvax <- df_unvax %>% filter(term == !!term) %>% pull(logHR)
  SE_unvax    <- df_unvax %>% filter(term == !!term) %>% pull(SE)
  
  DiD_logHR <- logHR_vax - logHR_unvax
  DiD_SE <- sqrt(SE_vax^2 + SE_unvax^2)
  Z <- DiD_logHR / DiD_SE
  P_value <- 2 * pnorm(-abs(Z))
  
  period_idx <- as.integer(gsub("exposure_start_day", "", term))
  period_label <- period_labels[period_idx]
  
  did_results <- rbind(did_results, data.frame(
    term = term,
    period_label = period_label,
    logHR_vax = logHR_vax,
    logHR_unvax = logHR_unvax,
    DiD_logHR = DiD_logHR,
    DiD_SE = DiD_SE,
    Z = Z,
    P_value = P_value
  ))
}

did_results %>%
  transmute(Období = period_label, `log(HR) Vakcinace` = logHR_vax, `log(HR) Bez vakcinace` = logHR_unvax, `DiD log(HR)` = DiD_logHR, p_value = P_value) %>%
  kable(format = "html", caption = "Porovnání rizik (SCCS) očkovaných a neočkovaných") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE
  )
```

## Shrnutí

Oproti ostatním kohortám dochází ve věkové kategorii `40-59` k mírnému propadu v prvopředpisovosti, kde mezi jednotlivými skupinami není významný rozdíl. Naopak měsíční multipředpisovost vykazuje nepatrný nárůst se statisticky signifikantním rozdílem mezi skupinami (konkrétně téměř nulový nárůst u očkovaných a zhruba 7% nárůst u neočkované populace.).

Trendy ve formě podání jsou téměř konstantní s jedinou výjimkou opět ve druhé polovině roku 2021.

Z hlediska krátkodobých rizik se trendy obou skupin víceméně kopírují s několika málo významnými odchylkami, kde je nižší riziko vypočtené u očkovaných.

# Závěr

Všeobecně je možné konstatovat, že riziko předpisu kortikoidsteroidů během covidu a v období po covidu rostlo a neustále roste. Co se týče vlivu očkování na tento trend, tak ve většině případů není možné zhodnotit rozdíly mezi skupinami jako významné. V několika případech, kdy se riziko liší, je vakcinovaná populace vyhodnocená jako méně riziková s jedinou výjimkou u rizik celkového počtu předpisů 270-365 dní po vakcinaci pro kohortu ve věku 16-39 let.

V zásadě je také možné říct, že rizika se týkala zejména mladší populace. V případě starší populace sledujeme spíše konstantní rizika a nebo v některých případech dokonce nepatrné snížení.

Ve zkratce tedy:

**Změnila se v období pandemie nějak celková spotřeba kortikoidů?** Ano. Nejprve došlo k očekávatelnému propadu a poté došlo k navýšení, které přesahuje trend nastavený předcovidovým obdobím.

**Jsou trendy týkající se spotřeby kortikoidů stejné u očkované i neočkované populace? Chránily tedy vakcíny před nárůstem spotřeby kortikoidů, neměly žádný efekt, nebo dokonce škodily?** Trendy jsou v zásadě srovnatelné a v případech, kdy tomu tak není, je vakcinovaná populace vyhodnocená jako s nižším rizikem.

**Je rozdíl mezi jednotlivými věkovými skupinami?** Ano. K největším rozdílům oproti celkovému trendu dochází u mladší populace. Je však otázka zdali to není způsobené prostým stárnutím dané kohorty.

Je důležité zmínit, že samotné zvýšení počtu předpisů nemusí nutně znamenat zhoršení situace. Vzhledem k tomu, že se kortikoidy předepisují na celou škálu různých problémů a každý problém má rozdílné dávkovací schéma, může jednoduše docházet i k nárůstu diagnóz s nutností častějšího (nebo sezónního) dávkování. Vzhledem k naší odbornosti by ale bylo případné zhodnocení spíše spekulací.

Zajímavé bylo pozorovat výrazný rozdíl v poměru předepsaných injekcí / infuzí na tablety u neočkované populace ve druhé polovině roku 2022. Došlo zde totiž k výraznému snížení počtu injekcí / infuzí a zároveň i zvýšení tablet. Zdali se jedná o výsledky covidových nařízení nebo jiné důvody opět přenecháme erudovanějším osobám.

Během zkoumání bylo (přirozeně) nalezeno mnoho slepých uliček, ale i zajímavých dat, která nejsou v tomto textu z kapacitních důvodů uvedena. Zejména data týkající se multipředpisovosti mohou ukázat mnoho dalších směrů k bádání. Pro příklad: průměrné intervaly mezi jednotlivými předpisy na omezeném intervalu 0-365, míra rizika druhého předpisu po prvním předpisu v čase, vliv incidence COVID-19 na předpisovost kortikoidů, průměrný počet předpisů na multipředepisovaného klienta, změny v sezónnosti předpisů a mnoho dalších.